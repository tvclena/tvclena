<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<!-- Google  tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T97MS35TJ6');
</script>

<title>Clena | TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0f10">

<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Clena TV">
<link rel="apple-touch-icon" href="logo1.png">
<link rel="apple-touch-startup-image" href="logo1.png">
<style>
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:none}
*::-webkit-scrollbar{display:none}

:root{
  --bg:#0f0f10;
  --surface:#1b1b1e;
  --card:#232326;
  --accent:#e50914;
  --text:#fff;
  --muted:#b5b5b5;
}

body{
  font-family:Inter,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ================ HEADER ================ */
header{
  position:fixed;
  top:0;
  left:0;
  right:0;
  height:64px;

  z-index:100;
  display:flex;
  align-items:center;
  gap:20px;
  padding:0 40px;

  background:linear-gradient(
    to bottom,
    rgba(0,0,0,.9),
    rgba(0,0,0,.5),
    rgba(0,0,0,0)
  );
}


/* PERFIL */
#perfilBtn{
  margin-left:auto;
  cursor:pointer;
}
#perfilBtn span{
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:50%;
  background:var(--accent);
  font-weight:700;
}
header input{
  font-size:16px;
}
input, textarea, select {
  touch-action: manipulation;
}

/* ================= HERO ================= */
.hero{
  height:85vh;
  padding:64px 40px 80px; /* s√≥ empurra o conte√∫do */
  display:flex;
  align-items:flex-end;
  position:relative;
  overflow:hidden;
}

.hero::before{
  content:"";
  position:absolute;
  inset:0;
  z-index:1;
  pointer-events:none;
  background:
    linear-gradient(
      to right,
      rgba(0,0,0,.88) 0%,
      rgba(0,0,0,.75) 35%,
      rgba(0,0,0,.45) 55%,
      rgba(0,0,0,.15) 70%,
      rgba(0,0,0,0) 85%
    ),
    linear-gradient(
      to top,
      rgba(0,0,0,.65) 0%,
      rgba(0,0,0,.35) 30%,
      rgba(0,0,0,0) 60%
    );
}


.hero-content{
  position:relative;
  z-index:2;
  max-width:560px;
}

.hero-content h2{
  font-size:52px;
  margin-bottom:12px;
  text-shadow: 0 4px 24px rgba(0,0,0,.9);
}

.hero-content .meta{
  color:var(--muted);
  margin-bottom:12px;
}

.hero-content p{
  line-height:1.6;
  margin-bottom:22px;
  text-shadow: 0 2px 12px rgba(0,0,0,.9);
}
.hero-desc{
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.hero-desc.expand{
  -webkit-line-clamp:unset;
}

.ler-mais{
  margin-top:-12px;
  margin-bottom:18px;
  font-size:14px;
  color:#3ea6ff;
  cursor:pointer;
  font-weight:600;
}
.ler-mais:hover{
  text-decoration:underline;
}


.hero-content button{
  padding:14px 32px;
  font-size:16px;
  font-weight:700;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:var(--accent);
  color:#fff;
}

/* REFOR√áO DO GRADIENTE NO DESKTOP */
@media (min-width:1024px){
  .hero::before{
    background:
      linear-gradient(
        to right,
        rgba(0,0,0,.92) 0%,
        rgba(0,0,0,.8) 40%,
        rgba(0,0,0,.45) 60%,
        rgba(0,0,0,0) 85%
      ),
      linear-gradient(
        to top,
        rgba(0,0,0,.7) 0%,
        rgba(0,0,0,.4) 30%,
        rgba(0,0,0,0) 60%
      );
  }
}
@media (max-width:768px){
  #heroVideo{
    height:60vh;
    object-fit:cover;
  }
}
#heroVideo{
  position:absolute;
  top:-28%;        /* üî• sobe mais */
  left:0;
  width:100%;
  height:150%;     /* üî• cobre tudo */
  object-fit:cover;
  object-position:center 40%;
  z-index:0;
}



/* ================= FILTROS ================= */

/* ================= FILTROS CATEGORIAS (SCROLL HORIZONTAL) ================= */

.filtros-categorias{
  padding:12px 40px 0;
  display:flex;
  gap:12px;

  overflow-x:auto;
  overflow-y:hidden;

  white-space:nowrap;
  scroll-behavior:smooth;

  -webkit-overflow-scrolling:touch;
}

/* garante que os bot√µes n√£o quebrem */
.filtros-categorias button{
  flex:0 0 auto;
}

/* esconde scrollbar */
.filtros-categorias::-webkit-scrollbar{
  display:none;
}
.filtros-categorias{
  scrollbar-width:none;
}

/* MOBILE */
@media (max-width:768px){
  .filtros-categorias{
    padding:10px 16px 0;
  }
}


.filtros{
  padding:30px 40px 0;
  display:flex;
  gap:12px;
}
.filtros button{
  padding:10px 18px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  background:#2b2b2b;
  color:#fff;
}
.filtros button.active{
  background:var(--accent);
}
@media (max-width:768px){
  input, textarea, select {
    font-size:16px;
  }
}

/* ================= SECTIONS ================= */
section{padding:40px}
section h3{margin-bottom:16px}

/* ================= GRID ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:20px;
}
.card{
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
  cursor:pointer;
  transition:.25s;
}
.card:hover{
  transform:scale(1.06);
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}
.card img{
  width:100%;
  height:260px;
  object-fit:cover;
}
.card .title{
  padding:12px;
  font-weight:600;
}

/* ================= PLAYER ================= */
#player{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:5000;
}
#close{
  position:absolute;
  top:16px;left:16px;
  padding:10px 16px;
  background:rgba(0,0,0,.6);
  color:#fff;
  border:none;
  border-radius:999px;
  cursor:pointer;
  z-index:10;
}
#playerLayout{
  display:grid;
  grid-template-columns:3fr 1.4fr;
  height:100%;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
}

#sideInfo{
  background:#111;
  padding:32px;
}
select{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  background:#1f1f1f;
  border:1px solid #333;
  color:#fff;
  border-radius:8px;
}

/* ================= PERFIL POPUP ================= */
#perfilOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:6000;
}
#perfilPopup{
  background:#1c1c1c;
  padding:24px;
  border-radius:12px;
  width:320px;
  text-align:center;
}
#perfilPopup h3{margin-bottom:8px}
#perfilPopup p{color:var(--muted)}
#perfilPopup button{
  width:100%;
  padding:12px;
  margin-top:12px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
#sair{background:var(--accent);color:#fff}
#fecharPerfil{background:#333;color:#fff}

/* ================= MOBILE ONLY ================= */
@media (max-width:768px){
header{padding:0 16px;height:56px}
header input{display:none}
.hero{height:60vh;padding:0 16px 40px}
.hero-content h2{font-size:26px}
section{padding:20px 14px}
.grid{grid-template-columns:repeat(3,1fr);gap:10px}
.card img{height:150px}
.card .title{font-size:12px;text-align:center}
#playerLayout{grid-template-columns:1fr}
#sideInfo{padding:16px}
}

.perfil-info{
  margin:16px 0;
  text-align:left;
  font-size:14px;
}
.perfil-info div{
  margin-bottom:6px;
}

#pixBox{
  background:#111;
  border:1px solid #333;
  border-radius:8px;
  padding:12px;
  margin-bottom:12px;
  text-align:center;
}
#perfilPix{
  margin-top:6px;
  font-weight:700;
  color:#00ff99;
}
/* ‚ñ∂ BOT√ÉO PR√ìXIMO EPIS√ìDIO */
#btnProximo{
  position:absolute;
  right:40px;
  bottom:120px;
  padding:12px 22px;
  border-radius:6px;
  border:none;
  font-size:15px;
  font-weight:600;
  cursor:pointer;

  background:rgba(255,255,255,.15);
  color:#fff;
  backdrop-filter: blur(6px);

  display:none;
  z-index:20;
}

#btnProximo:hover{
  background:rgba(255,255,255,.28);
}
html, body {
  overscroll-behavior: none;
  touch-action: manipulation;
}
#searchResults{
  position:fixed;
  top:64px;
  left:50%;
  transform:translateX(-50%);

  width:92%;
  max-width:1100px;
  max-height:70vh;
  overflow-y:auto;

  background:#111;
  border-radius:14px;
  padding:20px;

  display:none;

  z-index:99999;          /* üî• acima do hero e do v√≠deo */
  isolation:isolate;     /* üî• quebra stacking context */
  pointer-events:auto;

  overscroll-behavior:contain; /* üî• scroll N√ÉO vaza */
}




#searchResults h4{
  margin:0 0 14px;
  font-size:16px;
  color:var(--muted);
}

.search-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:14px;
}

.search-card{
  cursor:pointer;
}
.search-card img{
  width:100%;
  height:200px;
  object-fit:cover;
  border-radius:10px;
}
.search-card span{
  display:block;
  margin-top:6px;
  font-size:13px;
  text-align:center;
}

/* MOBILE */
@media(max-width:768px){
  #searchResults{
    top:56px;
    padding:14px;
    max-height:75vh;
  }

  .search-card img{
    height:140px;
  }
}
  
#searchBtn{
  display:none;
  font-size:20px;
  cursor:pointer;
}

@media (max-width:768px){
  header input{
    display:none;
  }
  #searchBtn{
    display:block;
  }
}

#buscaMobile{
  width:100%;
  padding:14px 18px;
  margin-bottom:16px;
  border-radius:999px;
  border:none;
  outline:none;
  font-size:16px;
  background:#2b2b2b;
  color:#fff;
  display:none;
}

/* mobile */
@media (max-width:768px){
  #buscaMobile{
    display:block;
  }
}
/* üîç BUSCA MOBILE INPUT */
#searchMobileBox{
  position:fixed;
  top:56px;
  left:0;
  right:0;
  padding:12px;
  background:rgba(0,0,0,.95);
  display:none;
  z-index: 9000;
}

#buscaMobile{
  width:100%;
  padding:14px 16px;
  border-radius:999px;
  border:none;
  font-size:16px;
  background:#2b2b2b;
  color:#fff;
}

#searchMobileBox{
  pointer-events: auto;
}

#searchResults{
  pointer-events: auto;
}
body.search-open{
  overflow:hidden;
  height:100vh;
}
.perfil-premium{
  background:#1c1c1c;
  padding:24px;
  border-radius:16px;
  width:340px;
  text-align:center;
}

.avatar-box{
  position:relative;
  margin-bottom:14px;
}

.avatar-box img{
  width:96px;
  height:96px;
  border-radius:50%;
  object-fit:cover;
  background:#333;
}

.avatar-upload{
  display:block;
  margin-top:8px;
  font-size:13px;
  color:#3ea6ff;
  cursor:pointer;
}
.avatar-upload input{display:none}

.perfil-premium input{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid #333;
  background:#111;
  color:#fff;
  margin-bottom:10px;
}

.username-box{
  display:flex;
  align-items:center;
  background:#111;
  border:1px solid #333;
  border-radius:8px;
  padding-left:10px;
}
.username-box span{
  color:#777;
}
.username-box input{
  border:none;
  background:none;
  margin:0;
}

#usernameStatus{
  font-size:12px;
  display:block;
  margin-bottom:10px;
}

.logo{
  font-size:22px;
  font-weight:800;
  letter-spacing:1px;
  display:flex;
  align-items:center;
  gap:6px;
  user-select:none;
}

.logo-clena{
  color:#fff;
}

.logo-tv{
  color:var(--accent);
}
.search-box{
  flex:1;
  max-width:420px;
  height:40px;

  display:flex;
  align-items:center;
  gap:10px;

  padding:0 16px;
  border-radius:999px;

  background:rgba(255,255,255,.08);
  backdrop-filter: blur(10px);

  border:1px solid rgba(255,255,255,.12);
  transition:.25s;
}

.search-box:hover{
  background:rgba(255,255,255,.12);
}

.search-box:focus-within{
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(229,9,20,.35);
}

.search-icon{
  font-size:16px;
  opacity:.7;
}

.search-box input{
  flex:1;
  height:100%;
  background:none;
  border:none;
  outline:none;
  color:#fff;
  font-size:15px;
}

.search-box input::placeholder{
  color:#bbb;
}
/* üö´ ESCONDE BUSCA DESKTOP NO MOBILE */
@media (max-width:768px){
  .search-box{
    display:none;
  }
}


/* ================= PERFIL MODULAR NOVO ================= */
#perfilOverlayNovo{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9000;
}

#perfilPopupNovo{
  background:#1c1c1c;
  border-radius:18px;
  padding:28px;
  width:420px;
  max-width:92%;
  display:grid;
  grid-template-columns:120px 1fr;
  gap:22px;
}

.perfil-col{
  display:flex;
  flex-direction:column;
}

.avatar-col{
  align-items:center;
}

.avatar-col img{
  width:96px;
  height:96px;
  border-radius:50%;
  object-fit:cover;
  background:#333;
}

.avatar-upload-novo{
  margin-top:10px;
  font-size:13px;
  color:#3ea6ff;
  cursor:pointer;
}
.avatar-upload-novo input{display:none}

.dados-col h3{
  margin-bottom:12px;
}

.dados-col label{
  font-size:12px;
  color:#999;
  margin-top:10px;
  margin-bottom:4px;
}

.dados-col input{
  padding:10px;
  border-radius:8px;
  border:1px solid #333;
  background:#111;
  color:#fff;
}

.username-box-novo{
  display:flex;
  align-items:center;
  background:#111;
  border:1px solid #333;
  border-radius:8px;
  padding-left:10px;
}

.username-box-novo span{
  color:#777;
}

.username-box-novo input{
  border:none;
  background:none;
  margin:0;
}

#perfilUsernameStatus{
  font-size:12px;
  margin-top:4px;
}

.perfil-info-novo{
  margin-top:14px;
  font-size:13px;
  color:#ccc;
}

.perfil-info-novo div{
  margin-bottom:6px;
}

.perfil-acoes{
  display:flex;
  gap:10px;
  margin-top:18px;
}

.perfil-acoes button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.btn-salvar{background:#e50914;color:#fff}
.btn-sair{background:#333;color:#fff}
.btn-fechar{background:#222;color:#fff}

@media(max-width:520px){
  #perfilPopupNovo{
    grid-template-columns:1fr;
    text-align:center;
  }
}

body.search-open .hero,
body.search-open .hero * {
  pointer-events: none;
}
#searchResults {
  pointer-events: auto;
  position: fixed;
  z-index: 99999;
}

.search-card {
  pointer-events: auto;
  cursor: pointer;
}
body.search-open {
  overflow: hidden;
}

#searchResults,
#searchResults * {
  pointer-events: auto !important;
}

/* ================= PLANOS BLOQUEIO ================= */
.planos-bloqueio {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 18px;

  max-height: 70vh;       /* üî• limite vis√≠vel */
  overflow-y: auto;       /* üî• libera rolagem */
  padding-right: 6px;

  overscroll-behavior: contain;
}


.plano-card {
  background: linear-gradient(180deg,#232326,#1a1a1c);
  border-radius: 18px;
  padding: 22px 18px;
  text-align: center;
  position: relative;
  box-shadow: 0 20px 40px rgba(0,0,0,.55);
}

.plano-card h3 {
  font-size: 18px;
  margin-bottom: 6px;
}

.plano-preco {
  font-size: 32px;
  font-weight: 900;
  margin: 10px 0;
}

.plano-preco span {
  font-size: 14px;
  color: #b5b5b5;
}

.plano-card ul {
  list-style: none;
  padding: 0;
  margin: 14px 0 18px;
  font-size: 13px;
  color: #ccc;
}

.plano-card ul li::before {
  content: "‚úì";
  color: #22c55e;
  margin-right: 6px;
}

.plano-btn {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: #e50914;
  color: #fff;
  font-weight: 800;
  cursor: pointer;
}

.plano-btn:hover {
  filter: brightness(1.1);
}

/* DESTAQUE */
.plano-card.destaque {
  border: 2px solid #e50914;
  box-shadow:
    0 0 0 1px rgba(229,9,20,.4),
    0 20px 40px rgba(229,9,20,.25);
}



@media (max-width: 768px) {
  .planos-bloqueio {
    grid-template-columns: 1fr;
    max-height: 75vh;   /* üî• ainda mais espa√ßo */
  }
}

/* üîê POPUP SESS√ÉO PREMIUM */
#sessaoOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;
  backdrop-filter: blur(6px);
}

.sessaoPopup{
  width:420px;
  max-width:92%;
  background:linear-gradient(180deg,#1b1b1e,#121214);
  border-radius:20px;
  padding:40px 32px;
  text-align:center;
  box-shadow:0 50px 120px rgba(0,0,0,.85);
  animation:popupIn .35s cubic-bezier(.2,.8,.2,1);
}

@keyframes popupIn{
  from{opacity:0;transform:translateY(12px) scale(.96)}
  to{opacity:1;transform:none}
}

.sessaoIcon{
  width:64px;
  height:64px;
  margin:0 auto 18px;
  border-radius:50%;
  background:rgba(229,9,20,.15);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  color:#e50914;
}

.sessaoPopup h2{
  margin:0 0 12px;
  font-size:24px;
  font-weight:900;
}

.sessaoText{
  font-size:15px;
  color:#cfcfcf;
  line-height:1.5;
  margin-bottom:22px;
}

.sessaoBox{
  background:#0f0f10;
  border:1px solid #2c2c2c;
  border-radius:14px;
  padding:14px;
  margin-bottom:26px;
  text-align:left;
}

.sessaoLabel{
  font-size:11px;
  color:#888;
  display:block;
  margin-bottom:6px;
}

.sessaoDevice{
  font-size:13px;
  color:#e5e5e5;
  word-break:break-word;
}

.sessaoBtn{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  background:#e50914;
  color:#fff;
  font-size:15px;
  font-weight:800;
  cursor:pointer;
}

.sessaoBtn:hover{
  filter:brightness(1.1);
}
.perfil-apex{
  margin-top:14px;
  padding:14px;
  border-radius:12px;
  background:#111;
  border:1px solid #333;
  text-align:center;
}

.apex-valor{
  font-size:22px;
  font-weight:800;
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:6px;
}

.apex-nome{
  font-size:20px;
  font-weight:900;
}

.apex-a{
  color:#e50914; /* A vermelho */
}

.apex-pex{
  color:#3ea6ff; /* pex azul */
}

.apex-saiba{
  margin-top:6px;
  font-size:13px;
  color:#3ea6ff;
  cursor:pointer;
}

.apex-saiba:hover{
  text-decoration:underline;
}
#apexOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;

  overscroll-behavior: contain;
  touch-action: none;
}


.apexPopup{
  width:420px;
  max-width:94%;
  height:520px;
  max-height:85vh; /* üî• isso resolve no mobile */
  background:#0f0f10;
  border-radius:16px;
  overflow:hidden;
  position:relative;
  box-shadow:0 30px 80px rgba(0,0,0,.8);
}


.apexPopup iframe{
  width:100%;
  height:100%;
  border:none;
}

.apexFechar{
  position:absolute;
  top:10px;
  right:10px;
  background:#222;
  color:#fff;
  border:none;
  border-radius:50%;
  width:32px;
  height:32px;
  cursor:pointer;
  font-size:16px;
}
body.modal-open{
  overflow:hidden;
  height:100vh;
  touch-action:none;
}
/* ================= BOT√ÉO RECARREGAR CARTEIRA (NEO) ================= */
.btn-neo-apex{
  position: relative;
  width:100%;
  margin-top:14px;
  padding:12px 18px;

  background:#0f0f10;
  border:none;
  border-radius:999px;

  color:#fff;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  overflow:hidden;
}

/* texto */
.btn-neo-apex span{
  position:relative;
  z-index:2;
}

/* borda animada circulando */
.btn-neo-apex::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:999px;
  padding:1.5px;

  background:conic-gradient(
    from 0deg,
    #e50914,
    #3ea6ff,
    #e50914
  );

  -webkit-mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
          mask-composite:exclude;

  animation:neo-giro 3s linear infinite;
}

/* fundo interno */
.btn-neo-apex::after{
  content:"";
  position:absolute;
  inset:1.5px;
  background:#0f0f10;
  border-radius:999px;
  z-index:1;
}

/* anima√ß√£o */
@keyframes neo-giro{
  to{ transform:rotate(360deg); }
}
#filtrosOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;

  overscroll-behavior: contain;
}

.filtrosPopup{
  width:900px;
  max-width:95%;
  height:650px;
  max-height:85vh;

  background:#0f0f10;
  border-radius:18px;
  overflow:hidden;
  position:relative;

  box-shadow:0 30px 80px rgba(0,0,0,.8);
}

.filtrosPopup iframe{
  width:100%;
  height:100%;
  border:none;
}

.filtrosFechar{
  position:absolute;
  top:10px;
  right:10px;
  background:#222;
  color:#fff;
  border:none;
  border-radius:50%;
  width:32px;
  height:32px;
  cursor:pointer;
  font-size:16px;
}

  
</style>
</head>

<body>

<!-- üöÄ ABERTURA -->
<iframe
  id="aberturaFrame"
  src="abertura.html"
  style="
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    border:none;
    z-index:999999;
    background:#0f0f10;
  ">
</iframe>




  
<header>
  <h1 class="logo">
    <span class="logo-clena">CLENA</span>
    <span class="logo-tv">TV</span>
  </h1>

  <!-- BUSCA DESKTOP BONITA -->
  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input
      id="busca"
      placeholder="Buscar filmes e s√©ries..."
      autocomplete="off"
    >
  </div>

<div id="perfilBtn" onclick="perfilAbrir()"><span>US</span></div>

  <!-- mobile -->
<div id="searchBtn">üîç</div>
</header>

<!-- üîç BUSCA MOBILE -->
<div id="searchMobileBox">
  <input
    id="buscaMobile"
    placeholder="Buscar filmes e s√©ries..."
    autocomplete="off"
  >
</div>

<!-- üîç RESULTADOS -->
<div id="searchResults">
  <h4>Resultados</h4>
  <div class="search-grid" id="searchGrid"></div>
</div>


<div class="hero" id="hero">

  <!-- üé¨ PREVIEW DE FUNDO -->
  <video
    id="heroVideo"
    autoplay
    muted
    loop
    playsinline
    style="
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:0;
    "
  ></video>

  <div class="hero-content">
    <h2 id="heroTitle"></h2>
    <div class="meta" id="heroMeta"></div>
<p id="heroDesc" class="hero-desc"></p>

<div id="lerMais" class="ler-mais" style="display:none"
     onclick="abrirPlayer(heroItem)">
  Ler mais
</div>

<button onclick="abrirPlayer(heroItem)">‚ñ∂ Assistir</button>

  </div>


</div>

<div class="filtros">
<button class="active" onclick="setFiltro('todos', this)">Todos</button>
<button onclick="setFiltro('filme', this)">Filmes</button>
<button onclick="setFiltro('serie', this)">S√©ries</button>
<button onclick="setFiltro('documentarios', this)">Document√°rios</button>
</div>
<div class="filtros" style="padding:12px 40px 0">
  <button onclick="abrirFiltrosAvancados()"
    style="
      background:#2b2b2b;
      color:#fff;
      padding:10px 18px;
      border-radius:999px;
      border:none;
      cursor:pointer;
    ">
    üéõÔ∏è Filtros avan√ßados
  </button>
</div>

<div class="filtros filtros-categorias" id="filtrosCategorias">
  <!-- categorias geradas via JS -->
</div>

<section>
  <h3>Cat√°logo</h3>
  <div class="grid" id="grid"></div>
</section>

<!-- PLAYER -->
<div id="player">
  <button id="close" onclick="fechar()">‚Üê</button>

  <div id="playerLayout">

    <!-- üé¨ V√çDEO -->
    <video id="video" controls autoplay></video>

    <!-- ‚ñ∂ PR√ìXIMO EPIS√ìDIO (aparece 1 min antes) -->
    <button id="btnProximo" onclick="irProximoEpisodio()">
      ‚ñ∂ Pr√≥ximo epis√≥dio
    </button>

    <!-- ‚ÑπÔ∏è INFORMA√á√ïES -->
    <div id="sideInfo">
      <h2 id="pTitle"></h2>
      <div class="meta" id="pMeta"></div>
      <p id="pDesc"></p>

      <div id="serieControls">
        <select id="selTemporada"></select>
        <select id="selEpisodio"></select>
      </div>
    </div>

  </div>
</div>


<!-- ================= PERFIL MODULAR NOVO ================= -->
<div id="apexOverlay" style="display:none">
  <div class="apexPopup">
    <button class="apexFechar" onclick="fecharApexInfo()">‚úï</button>
    <iframe src="apex.html"></iframe>
  </div>
</div>

<div id="perfilOverlayNovo">
  <div id="perfilPopupNovo">

    <div class="perfil-col avatar-col">
      <img id="perfilAvatarNovo" src="" alt="Avatar">
      <label class="avatar-upload-novo">
        Alterar foto
        <input type="file" accept="image/*" onchange="perfilUploadAvatar(this)">
      </label>
    </div>

    <div class="perfil-col dados-col">
      <h3>Meu Perfil</h3>

      <label>Nome</label>
      <input id="perfilNomeNovo">

      <label>Usu√°rio</label>
      <div class="username-box-novo">
        <span>@</span>
        <input id="perfilUsernameNovo" oninput="perfilValidarUsername()">
      </div>
      <small id="perfilUsernameStatus"></small>

      <div class="perfil-info-novo">
        <div><strong>Email:</strong> <span id="perfilEmailNovo"></span></div>
        <div><strong>Plano:</strong> <span id="perfilPlanoNovo"></span></div>
        <div><strong>Valor:</strong> <span id="perfilValorNovo"></span></div>
        <div><strong>Vencimento:</strong> <span id="perfilVencimentoNovo"></span></div>
      </div>
<button class="btn-neo-apex" onclick="abrirApexInfo()">
  <span>Recarregar carteira</span>
</button>

      <div class="perfil-apex">
  <div class="apex-valor">
    <span id="apexQtd">0</span>
    <span class="apex-nome">
      <span class="apex-a">A</span><span class="apex-pex">pex</span>
    </span>
  </div>

  <div class="apex-saiba" onclick="abrirApexInfo()">
    Saiba mais
  </div>
</div>

      <div class="perfil-acoes">
        <button class="btn-salvar" onclick="perfilSalvar()">Salvar</button>
        <button class="btn-sair" onclick="logout()">Sair</button>
        <button class="btn-fechar" onclick="perfilFechar()">Fechar</button>
      </div>
    </div>

  </div>
</div>








  
<script src="env.js"></script>
<script>
const sb = supabase.createClient(
  window.ENV.SUPABASE_URL,
  window.ENV.SUPABASE_ANON_KEY
);
// ================= APEX CONVERS√ÉO =================
const APEX_POR_REAL = 15;

function reaisParaApex(reais){
  return Math.floor(Number(reais) * APEX_POR_REAL);
}

function apexParaReais(apex){
  return (Number(apex) / APEX_POR_REAL).toFixed(2);
}




  
let redirecionando = false;

/* ================= PERFIL NOVO ISOLADO ================= */
let perfilUserId = null;

const pAvatar = document.getElementById("perfilAvatarNovo");
const pNome = document.getElementById("perfilNomeNovo");
const pUser = document.getElementById("perfilUsernameNovo");
const pStatus = document.getElementById("perfilUsernameStatus");
const pEmail = document.getElementById("perfilEmailNovo");
const pPlano = document.getElementById("perfilPlanoNovo");
const pValor = document.getElementById("perfilValorNovo");
const pVenc = document.getElementById("perfilVencimentoNovo");

function perfilAbrir(){
  document.getElementById("perfilOverlayNovo").style.display="flex";
  perfilCarregar();
}
function perfilFechar(){
  document.getElementById("perfilOverlayNovo").style.display="none";
}

async function perfilCarregar(){
  const email = localStorage.getItem("usuario_email");
  if (!email) return;

  const { data: user, error } = await sb
    .from("usuarios")
    .select(`
      id,
      email,
      nome_usuario,
      username,
      avatar_url,
      tipo_assinatura,
      valor_assinatura,
      vencimento_assinatura
    `)
    .eq("email", email)
    .single();

  if (error || !user) {
    console.error("Erro ao carregar perfil:", error);
    return;
  }

  perfilUserId = user.id;

  // üìß Dados b√°sicos
  pEmail.textContent = user.email;
  pNome.value = user.nome_usuario || "";
  pUser.value = user.username || "";

  // üñº Avatar
  pAvatar.src =
    user.avatar_url ||
    `https://ui-avatars.com/api/?name=${(user.nome_usuario || "U")[0]}&background=e50914&color=fff`;

  // üí≥ Plano (vem DIRETO do usu√°rio)
  pPlano.textContent = user.tipo_assinatura || "-";

  pValor.textContent = user.valor_assinatura
    ? Number(user.valor_assinatura).toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
      })
    : "-";

  pVenc.textContent = user.vencimento_assinatura
    ? new Date(user.vencimento_assinatura).toLocaleDateString("pt-BR")
    : "-";
  await carregarApex();
}



async function perfilValidarUsername(){
  const u = pUser.value.toLowerCase().replace(/[^a-z0-9._]/g,"");
  pUser.value = u;

  if(u.length < 3){
    pStatus.textContent="Muito curto";
    pStatus.style.color="#ff5555";
    return false;
  }

  const { data } = await sb
    .from("usuarios")
    .select("id")
    .eq("username", u)
    .neq("id", perfilUserId);

  if(data.length){
    pStatus.textContent="J√° em uso";
    pStatus.style.color="#ff5555";
    return false;
  }

  pStatus.textContent="Dispon√≠vel";
  pStatus.style.color="#00ff99";
  return true;
}

async function perfilSalvar(){
  if(!(await perfilValidarUsername())) return;

  await sb.from("usuarios")
    .update({
      nome_usuario: pNome.value,
      username: pUser.value
    })
    .eq("id", perfilUserId);

  perfilFechar();
}


async function perfilUploadAvatar(input){
  const file = input.files[0];
  if(!file || !perfilUserId) return;

  const img = new Image();
  img.src = URL.createObjectURL(file);
  await new Promise(r => img.onload = r);

  const canvas = document.createElement("canvas");
  canvas.width = 512;
  canvas.height = 512;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img,0,0,512,512);

  const blob = await new Promise(r =>
    canvas.toBlob(r,"image/jpeg",0.9)
  );

  URL.revokeObjectURL(img.src);

  const nome = `${perfilUserId}_${Date.now()}.jpg`;

  const uploadUrl =
    `https://br.storage.bunnycdn.com/sessao99/avatars/${nome}`;

  const res = await fetch(uploadUrl,{
    method:"PUT",
    headers:{
      "AccessKey":"d498d56e-361b-4a1e-9edb9eb63e3b-2e6a-4c17",
      "Content-Type":"application/octet-stream"
    },
    body:blob
  });

  if(!res.ok){
    alert("Erro ao enviar avatar");
    return;
  }

  const avatarUrl =
    `https://sessao99.b-cdn.net/avatars/${nome}`;

  await sb.from("usuarios")
    .update({ avatar_url: avatarUrl })
    .eq("id", perfilUserId);

  pAvatar.src = avatarUrl;
  await carregarAvatarHeader();
}






  


let dados=[], heroItem=null, filtro='todos', usuario=null;
let serieAtual=[], filmeAtual=null;
let episodioIndexAtual = 0;
let dadosCarregados = false;
let categoriaAtiva = "todas";


// ================= ELEMENTOS DOM =================
const hero = document.getElementById("hero");
const heroTitle = document.getElementById("heroTitle");
const heroMeta = document.getElementById("heroMeta");
const heroDesc = document.getElementById("heroDesc");
const grid = document.getElementById("grid");


const video = document.getElementById("video");
const btnProximo = document.getElementById("btnProximo");
const selTemporada = document.getElementById("selTemporada");
const selEpisodio = document.getElementById("selEpisodio");


  
const ID_PRINCIPAL = "649a1523-e49b-49d8-a34a-452a54b04ba";

async function iniciarApp() {



const { data, error } = await sb
  .from("filmes")
  .select("*");



if (error) {
  console.error(error);
  alert("Erro ao carregar cat√°logo");
  return;
}


  console.log("üé¨ FILMES CARREGADOS:", data);

dados = (data || []).map(d => {
  // üî¢ classifica√ß√£o indicativa ‚Üí n√∫mero
  let classificacaoNum = null;
  if (d.classificacao_indicativa) {
    const m = d.classificacao_indicativa.match(/\d+/);
    if (m) classificacaoNum = Number(m[0]);
  }

  return {
    ...d,

    // üìÜ ano
    ano_lancamento: d.ano_lancamento
      ? Number(d.ano_lancamento)
      : null,

    // ‚≠ê nota
    nota_critica: d.nota_critica
      ? Number(d.nota_critica)
      : null,

    // ‚è± dura√ß√£o
    duracao_minutos: d.duracao_minutos
      ? Number(d.duracao_minutos)
      : null,

    // üéö classifica√ß√£o pronta para filtro
    classificacao_num: classificacaoNum,

    // üî§ normaliza texto
    idioma: (d.idioma || "").toLowerCase(),
    audio: (d.audio || "").toLowerCase()
  };
});
  dadosCarregados = true;
montarFiltrosCategorias(); // üëà ADICIONE AQUI

  if (!dados.length) {
    console.warn("‚ö†Ô∏è Nenhum filme ativo encontrado");
    return;
  }

  heroItem =
    dados.find(d => d.id === ID_PRINCIPAL) ||
    dados[0];

  hero.style.backgroundImage = `url(${heroItem.capa_url})`;
  heroTitle.textContent = heroItem.titulo || heroItem.serie_nome;
  heroMeta.textContent = `${heroItem.categoria} ‚Ä¢ ${heroItem.tipo}`;
  heroDesc.textContent = heroItem.descricao || "";

  const heroVideo = document.getElementById("heroVideo");

  if (heroItem.video_url) {
    heroVideo.pause();
    heroVideo.removeAttribute("src");
    heroVideo.load();

    heroVideo.src = heroItem.video_url;
    heroVideo.muted = true;
    heroVideo.autoplay = true;
    heroVideo.loop = true;

    heroVideo.play().catch(() => {});
  }

  render();
}




const searchMobileBox = document.getElementById("searchMobileBox");
const buscaMobile = document.getElementById("buscaMobile");
const searchResults = document.getElementById("searchResults");
const searchGrid = document.getElementById("searchGrid");

  
function abrirResultadoMobile(e) {
  e.preventDefault();
  e.stopPropagation();

  const card = e.currentTarget;
  const itemEncoded = card.dataset.item;
  if (!itemEncoded) return;

  document.body.classList.remove("search-open");
  searchResults.style.display = "none";
  searchMobileBox.style.display = "none";

  setTimeout(() => {
    location.href = `player.html?item=${itemEncoded}`;
  }, 100);
}

const busca = document.getElementById("busca");
function executarBusca(texto) {
  if (!dadosCarregados) {
    searchGrid.innerHTML =
      "<p style='color:#777'>Carregando cat√°logo...</p>";
    searchResults.style.display = "block";
    return;
  }

  
  const q = texto.trim().toLowerCase();

  if (q.length < 2) {
    searchResults.style.display = "none";
    searchGrid.innerHTML = "";
    return;
  }

const resultados = [
  // üé¨ FILMES
  ...dados.filter(d =>
    d.tipo === "filme" &&
    (d.titulo || "").toLowerCase().includes(q)
  ),

  // üì∫ S√âRIES AGRUPADAS POR serie_nome
  ...[
    ...new Map(
      dados
        .filter(d =>
          d.tipo === "serie" &&
          (d.serie_nome || "").toLowerCase().includes(q)
        )
        .map(s => [s.serie_nome, s])
    ).values()
  ]
];


  if (!resultados.length) {
    searchGrid.innerHTML =
      "<p style='color:#777'>Nenhum resultado encontrado</p>";

    
} else {
searchGrid.innerHTML = resultados.map(r => `
  <div class="search-card"
       ontouchstart="abrirResultadoMobile(event)"
       onclick="abrirResultadoMobile(event)"
       data-item='${encodeURIComponent(JSON.stringify(r))}'>
    <img src="${r.capa_url}">
    <span>${r.titulo || r.serie_nome}</span>
  </div>
`).join("");
  }

  searchResults.style.display = "block";
}


function toggleSearch(){
  searchMobileBox.style.display = "block";
  searchResults.style.display = "none";
  buscaMobile.value = "";
  document.body.classList.add("search-open");

  // for√ßa foco sem zoom
  setTimeout(() => buscaMobile.focus(), 100);
}
const searchBtn = document.getElementById("searchBtn");

searchBtn.addEventListener("touchstart", e => {
  e.preventDefault();
  e.stopPropagation();
  toggleSearch();
});

searchBtn.addEventListener("click", e => {
  e.preventDefault();
  e.stopPropagation();
  toggleSearch();
});


buscaMobile.oninput = () => {
  executarBusca(buscaMobile.value);
};

if (busca) {
  busca.oninput = () => {
    executarBusca(busca.value);
  };
}


document.addEventListener("click", e => {
  if (
    searchResults.contains(e.target) ||
    searchMobileBox.contains(e.target) ||
    e.target.closest(".search-card") ||
    e.target.closest("#searchBtn") // üî• ESSENCIAL
  ) {
    return;
  }

  searchMobileBox.style.display = "none";
  searchResults.style.display = "none";
  searchGrid.innerHTML = "";
  document.body.classList.remove("search-open");
});




function setFiltro(f, el){
  filtro = f;

  document
    .querySelectorAll(".filtros button")
    .forEach(b => b.classList.remove("active"));

  el.classList.add("active");
  render(busca.value.toLowerCase());
}


function card(i){
  return `
    <div class="card" onclick='abrirPlayer(${JSON.stringify(i)})'>
      <img src="${i.capa_url}">
      <div class="title">
        ${i.titulo || i.serie_nome}
      </div>
    </div>
  `;
}

function renderComFiltros(f){
  grid.innerHTML = "";

  dados.filter(d => {

    // üîç busca texto
    if (f.busca && !JSON.stringify(d).toLowerCase().includes(f.busca)) {
      return false;
    }

// üéö CLASSIFICA√á√ÉO INDICATIVA (IDADE)
if (f.classificacao !== undefined) {
  if (
    d.classificacao_num !== null &&
    d.classificacao_num > f.classificacao
  ) {
    return false;
  }
}


    // üìÜ ano
    if (f.anos?.length && !f.anos.includes(String(d.ano_lancamento))) {
      return false;
    }

    // üé≠ categorias
    if (f.generos?.length) {
      const cats = (d.categoria || "").toLowerCase();
      if (!f.generos.some(g => cats.includes(g.toLowerCase()))) {
        return false;
      }
    }

    // üé¨ tipo
    if (f.tipos?.length && !f.tipos.includes(d.tipo)) {
      return false;
    }

// ‚≠ê NOTA M√çNIMA
if (f.notaMin && d.nota_critica !== null) {
  if (d.nota_critica < f.notaMin) return false;
}

// ‚è± DURA√á√ÉO M√çNIMA
if (f.duracaoMin && d.duracao_minutos !== null) {
  if (d.duracao_minutos < f.duracaoMin) return false;
}

// üåç IDIOMA
if (f.idiomas?.length) {
  if (!f.idiomas.some(i => d.idioma.includes(i.toLowerCase()))) {
    return false;
  }
}

// üîä √ÅUDIO
if (f.audios?.length) {
  if (!f.audios.some(a => d.audio.includes(a.toLowerCase()))) {
    return false;
  }
}










    
    return true;
  }).forEach(item => {
    grid.innerHTML += card(item);
  });
}

function aplicarFiltrosAvancados(){
  const filtros = JSON.parse(
    localStorage.getItem("clena_filtros") || "{}"
  );

  // normaliza busca
  if (filtros.busca) {
    filtros.busca = filtros.busca.toLowerCase();
  }


  
  renderComFiltros(filtros);
}


  
function render(buscaTxt = "") {
  grid.innerHTML = "";

  // üîπ LISTA BASE (dados ‚Üí categoria)
  let lista = dados;

if (categoriaAtiva !== "todas") {
  lista = lista.filter(d => {
    if (!d.categoria) return false;

    const categorias = d.categoria
      .split(",")
      .map(c => c.trim().toLowerCase());

    return categorias.includes(categoriaAtiva.toLowerCase());
  });
}


  // üé¨ FILMES
  if (filtro === "todos" || filtro === "filme") {
    lista
      .filter(d => (d.tipo || "").toLowerCase() === "filme")
      .filter(d => JSON.stringify(d).toLowerCase().includes(buscaTxt))
      .forEach(f => grid.innerHTML += card(f));
  }

  // üì∫ S√âRIES (AGRUPADAS)
  if (filtro === "todos" || filtro === "serie") {
    const series = [
      ...new Map(
        lista
          .filter(d => (d.tipo || "").toLowerCase() === "serie")
          .map(s => [s.serie_nome, s])
      ).values()
    ];

    series
      .filter(s => JSON.stringify(s).toLowerCase().includes(buscaTxt))
      .forEach(s => grid.innerHTML += card(s));
  }

  // üî¥ JOGOS AO VIVO
  if (filtro === "todos" || filtro === "jogos_ao_vivo") {
    lista
      .filter(d => (d.tipo || "").toLowerCase() === "jogos_ao_vivo")
      .filter(d => JSON.stringify(d).toLowerCase().includes(buscaTxt))
      .forEach(j => grid.innerHTML += card(j));
  }
}


function formatarReal(valor){
  if(valor == null) return "-";
  return valor.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  });
}

function formatarData(data){
  if(!data) return "-";
  return new Date(data).toLocaleDateString("pt-BR");
}

function abrirPlayer(item){
  const dados = encodeURIComponent(JSON.stringify(item));
  location.href = `player.html?item=${dados}`;
}



function montarSerie(){
  const temps=[...new Set(serieAtual.map(e=>e.temporada))];
  selTemporada.innerHTML=temps.map(t=>`<option>${t}</option>`).join("");
  selTemporada.onchange=montarEpisodios;
  montarEpisodios();
}
function montarEpisodios(){
  const eps = serieAtual.filter(
    e => e.temporada == selTemporada.value
  );

  selEpisodio.innerHTML = eps
    .map((e, i) => `<option value="${i}">Ep ${e.episodio}</option>`)
    .join("");

  episodioIndexAtual = 0;

  // ‚ñ∂Ô∏è reproduz o primeiro epis√≥dio
  tocarEpisodio(eps, episodioIndexAtual);

  selEpisodio.onchange = () => {
    episodioIndexAtual = Number(selEpisodio.value);
    tocarEpisodio(eps, episodioIndexAtual);
  };
}
function tocarEpisodio(eps, index){
  btnProximo.style.display = "none"; // üëà ESCONDE SEMPRE

  const episodio = eps[index];
  if(!episodio) return;

  video.src = episodio.video_url;
  video.play().catch(() => {});
}



function fechar(){
  video.pause();video.src="";
  document.getElementById("player").style.display = "none";
  document.getElementById("perfilBtn").style.display="block";
}



function logout(){
  localStorage.clear();
  sessionStorage.clear();
  location.replace("login.html");
}

function irProximoEpisodio(){
  btnProximo.style.display = "none";

  const temporadaAtual = selTemporada.value;
  const epsDaTemp = serieAtual.filter(
    e => e.temporada == temporadaAtual
  );

  episodioIndexAtual++;

  // ‚ñ∂Ô∏è pr√≥ximo epis√≥dio da mesma temporada
  if (episodioIndexAtual < epsDaTemp.length) {
    selEpisodio.value = episodioIndexAtual;
    tocarEpisodio(epsDaTemp, episodioIndexAtual);
    return;
  }

  // üîÑ pr√≥xima temporada
  const temporadas = [...new Set(serieAtual.map(e => e.temporada))];
  const tempIndex = temporadas.indexOf(Number(temporadaAtual));

  if (tempIndex < temporadas.length - 1) {
    selTemporada.value = temporadas[tempIndex + 1];
    montarEpisodios();
  }
}

video.addEventListener("ended", () => {

  // se n√£o estiver em s√©rie, ignora
  if (!serieAtual.length) return;

  const temporadaAtual = selTemporada.value;
  const epsDaTemp = serieAtual.filter(
    e => e.temporada == temporadaAtual
  );

  episodioIndexAtual++;

  // ‚ñ∂Ô∏è ainda tem epis√≥dio na mesma temporada
  if (episodioIndexAtual < epsDaTemp.length) {
    selEpisodio.value = episodioIndexAtual;
    tocarEpisodio(epsDaTemp, episodioIndexAtual);
    return;
  }

  // üîÑ acabou a temporada ‚Üí tenta pr√≥xima
  const temporadas = [...new Set(serieAtual.map(e => e.temporada))];
  const tempIndex = temporadas.indexOf(Number(temporadaAtual));

  if (tempIndex < temporadas.length - 1) {
    const proximaTemp = temporadas[tempIndex + 1];
    selTemporada.value = proximaTemp;
    montarEpisodios();
    return;
  }

  // üõë acabou a s√©rie
  console.log("S√©rie finalizada");
});
video.addEventListener("timeupdate", () => {

  // s√≥ funciona para s√©rie
  if (!serieAtual.length) return;

  if (!video.duration) return;

  const tempoRestante = video.duration - video.currentTime;

  // ‚è± mostra com 60 segundos restantes
  if (tempoRestante <= 60) {
    btnProximo.style.display = "block";
  } else {
    btnProximo.style.display = "none";
  }
});
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").then(reg => {

    // üî• for√ßa atualiza√ß√£o quando houver nova vers√£o
    if (reg.waiting) {
      reg.waiting.postMessage({ type: "SKIP_WAITING" });
    }

    reg.addEventListener("updatefound", () => {
      const newWorker = reg.installing;

      newWorker.addEventListener("statechange", () => {
        if (newWorker.state === "installed") {
          if (navigator.serviceWorker.controller) {
           if (!sessionStorage.getItem("sw_reloaded")) {
  sessionStorage.setItem("sw_reloaded", "1");
  location.reload();
}

          }
        }
      });
    });

  });
}
async function validarSessao() {
  const email = localStorage.getItem("usuario_email");
  const tokenLocal = localStorage.getItem("session_token");

  // üõë PASSO 3 ‚Äî SE N√ÉO TIVER EMAIL OU TOKEN, CAI FORA
if (!email || !tokenLocal) {
  localStorage.clear();

  if (!redirecionando) {
    redirecionando = true;
    location.replace("login.html");
  }

  return false;
}


 const { data, error } = await sb
  .from("usuarios")
.select("id, status, trial_expires_at, session_token, controle_sessao, tipo_assinatura")
  .eq("email", email)
  .maybeSingle();
// üî• REGRA OP√á√ÉO A ‚Äî LOGADO MAS SEM PLANO ‚Üí PLANOS
if (!data.tipo_assinatura) {
  if (!redirecionando) {
    redirecionando = true;
    location.replace("planos.html");
  }
  return false;
}


// üîê PASSO 4 ‚Äî CONTROLE DE SESS√ÉO (OUTRO DISPOSITIVO)
if (data.controle_sessao === true) {
  if (data.session_token !== tokenLocal) {

    const { data: ultimoLogin } = await sb
      .from("login_logs")
      .select("user_agent, created_at")
      .eq("user_id", data.id)
      .order("created_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    const agente =
      ultimoLogin?.user_agent || "Outro dispositivo";

mostrarSessaoEncerrada(agente);
return false;


    localStorage.clear();

    if (window.matchMedia("(display-mode: standalone)").matches) {
      location.href = "login.html";
    } else {
      location.replace("login.html");
    }

    return false;
  }
}


  const agora = new Date();
  const expira = new Date(data.trial_expires_at);

 if (data.status === "bloqueado") {
  const emailUser = email;

  const mensagem = encodeURIComponent(
`Ol√°, meu acesso est√° bloqueado.

üìß Email: ${emailUser}

Gostaria de regularizar minha assinatura.`
  );

  const whatsappUrl = `https://wa.me/5575998112535?text=${mensagem}`;

document.body.innerHTML = `
  <div style="
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#0f0f10;
    color:#fff;
    font-family:Inter,Arial;
    padding:20px;
  ">
    <div style="width:100%;max-width:960px">

      <!-- üö´ BLOQUEIO -->
      <div style="
        background:#1b1b1e;
        padding:30px;
        border-radius:16px;
        box-shadow:0 20px 40px rgba(0,0,0,.6);
        text-align:center;
        margin-bottom:26px;
      ">
        <h1 style="color:#e50914;margin-bottom:10px">
          üö´ Acesso bloqueado
        </h1>

        <p style="color:#ccc;margin-bottom:14px">
          Seu acesso est√° temporariamente bloqueado.<br>
          Escolha um plano abaixo para continuar assistindo.
        </p>

        <div style="font-size:12px;color:#777">
          Email: <strong>${email}</strong>
        </div>
      </div>

      <!-- üí≥ PLANOS AQUI EMBAIXO -->
      <div id="planosContainer"></div>

    </div>
  </div>
`;
carregarPlanosBloqueio();
return false;

}




  usuario = { email };
  return true;
}


async function abrirLinkPlano(nomePlano) {
  const email = localStorage.getItem("usuario_email");

  if (!email) {
    alert("Fa√ßa login para continuar");
    location.href = "login.html";
    return;
  }

  try {
    const res = await fetch("/api/create-payment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        plano: nomePlano,
        email: email
      })
    });

    const data = await res.json();

    if (data.url) {
      // üî• REDIRECIONA PARA O MERCADO PAGO
      window.location.href = data.url;
    } else {
      alert("Erro ao gerar link de pagamento");
      console.error(data);
    }

  } catch (err) {
    alert("Erro de conex√£o com o servidor");
    console.error(err);
  }
}



  

async function carregarAvatarHeader() {
  const email = localStorage.getItem("usuario_email");
  if (!email) return;

  const { data } = await sb
    .from("usuarios")
    .select("avatar_url, nome_usuario")
    .eq("email", email)
    .single();

  const avatarUrl =
    data?.avatar_url ||
    `https://ui-avatars.com/api/?name=${(data?.nome_usuario || "U")[0]}&background=e50914&color=fff`;

  perfilBtn.innerHTML = `
    <img src="${avatarUrl}"
         style="width:36px;height:36px;border-radius:50%;object-fit:cover">
  `;
}



(async () => {

  const ok = await validarSessao();
  if (!ok) return;

  await carregarAvatarHeader(); // ‚úÖ ESSENCIAL
  iniciarApp();

setInterval(() => {
  if (!redirecionando) {
    validarSessao();
  }
}, 15000);

window.addEventListener("message", (event) => {
  if (event.data === "filtros_aplicados") {
    aplicarFiltrosAvancados();
  }
});

  
})();

function abrirFiltrosAvancados(){
  localStorage.setItem("clena_dados", JSON.stringify(dados));
  document.body.classList.add("modal-open");
  document.getElementById("filtrosOverlay").style.display = "flex";
}
function fecharFiltros(){
  document.body.classList.remove("modal-open");
  document.getElementById("filtrosOverlay").style.display = "none";
}


  
function montarFiltrosCategorias(){
  const box = document.getElementById("filtrosCategorias");

  const todasCategorias = dados
    .flatMap(d =>
      (d.categoria || "")
        .split(",")
        .map(c => c.trim())
    )
    .filter(Boolean);

  const categoriasUnicas = [
    "todas",
    ...new Set(todasCategorias.map(c => c.toLowerCase()))
  ];

  box.innerHTML = categoriasUnicas.map((c,i) => `
    <button
      class="${i === 0 ? "active" : ""}"
      onclick="setCategoria('${c}', this)">
      ${c.charAt(0).toUpperCase() + c.slice(1)}
    </button>
  `).join("");
}

function setCategoria(cat, el){
  categoriaAtiva = cat;

  document
    .querySelectorAll(".filtros-categorias button")
    .forEach(b => b.classList.remove("active"));

  el.classList.add("active");

  render(busca?.value?.toLowerCase() || "");
}
async function carregarPlanosBloqueio() {
  const res = await fetch("/api/get-planos");
  const planos = await res.json();

  const box = document.getElementById("planosContainer");

  // üî• REMOVE APEX DA TELA DE BLOQUEIO
  const planosAssinatura = planos.filter(p =>
    !p.nome.toLowerCase().includes("apex")
  );

  box.innerHTML = `
    <div class="planos-bloqueio">
      ${planosAssinatura.map((plano, i) => `
        <div class="plano-card ${i === 1 ? "destaque" : ""}">
          <h3>${plano.nome}</h3>

          <div class="plano-preco">
            R$ ${Number(plano.valor).toFixed(2).replace(".", ",")}
            <span>/m√™s</span>
          </div>

          <ul>
            <li>Acesso completo</li>
            <li>Conte√∫do exclusivo</li>
            <li>Qualidade m√°xima</li>
          </ul>

          <button
            class="plano-btn"
            onclick="abrirLinkPlano('${plano.nome}')">
            Assinar agora
          </button>
        </div>
      `).join("")}
    </div>
  `;
}

function mostrarSessaoEncerrada(userAgent){
  document.getElementById("sessaoDevice").textContent =
    userAgent || "Outro dispositivo";

  document.getElementById("sessaoOverlay").style.display = "flex";
}

function sessaoSair(){
  localStorage.clear();
  sessionStorage.clear();

  if (window.matchMedia("(display-mode: standalone)").matches) {
    location.href = "login.html";
  } else {
    location.replace("login.html");
  }
}
function abrirApexInfo(){
  document.body.classList.add("modal-open");
  document.getElementById("apexOverlay").style.display = "flex";
}

function fecharApexInfo(){
  document.body.classList.remove("modal-open");
  document.getElementById("apexOverlay").style.display = "none";
}

async function carregarApex(){
  const email = localStorage.getItem("usuario_email");
  if (!email) return;

  try {
    const res = await fetch(`/api/carteira?email=${encodeURIComponent(email)}`);
    const data = await res.json();

    // üî• saldo vem em REAIS do backend
    const saldoReais = Number(data.apex || 0);

    // üî• converte para APEX
    const apex = reaisParaApex(saldoReais);

    document.getElementById("apexQtd").textContent = apex;

    // (opcional, mas PREMIUM) tooltip em reais
    document.getElementById("apexQtd").title =
      `‚âà R$ ${apexParaReais(apex)}`;

  } catch (err) {
    console.error("Erro ao carregar Apex:", err);
    document.getElementById("apexQtd").textContent = "0";
  }
}





</script>
  <!-- üîê POPUP SESS√ÉO ENCERRADA -->
<div id="sessaoOverlay" style="display:none">
  <div class="sessaoPopup">
    
    <div class="sessaoIcon">üîí</div>

    <h2>Voc√™ foi desconectado</h2>

    <p class="sessaoText">
      Detectamos um novo login na sua conta.
      <br>Por seguran√ßa, esta sess√£o foi encerrada.
    </p>

    <div class="sessaoBox">
      <span class="sessaoLabel">Dispositivo:</span>
      <div class="sessaoDevice" id="sessaoDevice">
        Outro dispositivo
      </div>
    </div>

    <button class="sessaoBtn" onclick="sessaoSair()">
      Entendi, sair
    </button>

  </div>
</div>
<!-- üéõÔ∏è POPUP FILTROS AVAN√áADOS -->
<div id="filtrosOverlay" style="display:none">
  <div class="filtrosPopup">
    <button class="filtrosFechar" onclick="fecharFiltros()">‚úï</button>
    <iframe src="filtros.html"></iframe>
  </div>
</div>

<script>
  // trava scroll enquanto a abertura est√° ativa
  document.body.style.overflow = "hidden";

  window.addEventListener("message", (event) => {
    if (event.data === "ABERTURA_OK") {
      const frame = document.getElementById("aberturaFrame");
      if (!frame) return;

      frame.style.transition = "opacity .6s ease";
      frame.style.opacity = "0";

      setTimeout(() => {
        frame.remove();
        document.body.style.overflow = "";
      }, 600);
    }
  });
</script>


  
</body>
</html>
