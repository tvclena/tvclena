<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Entrar â€¢ Clena TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="env.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  font-family:Inter,Arial,sans-serif;
  background:#0f0f10;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
}
.login-wrap{
  width:100%;
  max-width:420px;
  padding:28px;
}
.login-box{
  background:#1b1b1e;
  border-radius:18px;
  padding:34px 30px;
  box-shadow:0 40px 100px rgba(0,0,0,.8);
}
.logo{
  text-align:center;
  font-size:26px;
  font-weight:900;
  margin-bottom:6px;
}
.logo span{color:#e50914}
.subtitle{
  text-align:center;
  font-size:14px;
  color:#aaa;
  margin-bottom:28px;
}
input{
  width:100%;
  padding:14px 16px;
  margin-bottom:14px;
  border-radius:10px;
  border:1px solid #333;
  background:#111;
  color:#fff;
  font-size:15px;
}
input:focus{
  outline:none;
  border-color:#e50914;
  box-shadow:0 0 0 2px rgba(229,9,20,.35);
}
button{
  width:100%;
  padding:15px;
  border:none;
  border-radius:12px;
  background:#e50914;
  color:#fff;
  font-size:15px;
  font-weight:800;
  cursor:pointer;
}
button:disabled{
  opacity:.6;
  cursor:not-allowed;
}
button:hover:not(:disabled){
  filter:brightness(1.1);
}
.msg{
  margin-top:16px;
  text-align:center;
  font-size:14px;
}
.error{color:#ff5555}
.success{color:#22c55e}
.footer{
  text-align:center;
  margin-top:22px;
  font-size:13px;
  color:#888;
}
.footer a{
  color:#3ea6ff;
  text-decoration:none;
}
.footer a:hover{text-decoration:underline}
</style>
</head>

<body>

<div class="login-wrap">
  <div class="login-box">

    <div class="logo">CLENA <span>TV</span></div>
    <div class="subtitle">Acesse sua conta para continuar</div>

    <input id="email" type="email" placeholder="Email">
    <input id="senha" type="password" placeholder="Senha">

    <button id="btnLogin" onclick="login()">Entrar</button>

    <div id="msg" class="msg"></div>

    <div class="footer">
      Ao entrar vocÃª concorda com nossos termos.<br>
      <a href="#">Esqueci minha senha</a>
    </div>

  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  window.ENV.SUPABASE_URL,
  window.ENV.SUPABASE_ANON_KEY
);

let carregando = false;

/* ================= UTIL ================= */
function gerarToken(){
  return crypto.randomUUID();
}
function setMsg(texto, tipo="error"){
  const el = document.getElementById("msg");
  el.textContent = texto;
  el.className = "msg " + tipo;
}

/* ================= LOGIN ================= */
async function login(){
  if(carregando) return;
  carregando = true;

  const email = document.getElementById("email").value.trim().toLowerCase();
  const senha = document.getElementById("senha").value;
  const btn = document.getElementById("btnLogin");

  btn.disabled = true;
  setMsg("");

  if(!email || !senha){
    setMsg("Informe email e senha");
    btn.disabled = false;
    carregando = false;
    return;
  }

  const { data: user, error } = await sb
    .from("usuarios")
    .select(`
      id,
      email,
      senha,
      status,
      tipo_assinatura,
      controle_sessao
    `)
    .eq("email", email)
    .maybeSingle();

  if(error || !user){
    setMsg("Email ou senha invÃ¡lidos");
    btn.disabled = false;
    carregando = false;
    return;
  }

  /* ðŸ” valida senha
     ðŸ‘‰ aqui estÃ¡ em texto puro porque
     seu sistema atual funciona assim.
     Se quiser bcrypt depois, eu adapto. */
  if(user.senha !== senha){
    setMsg("Email ou senha invÃ¡lidos");
    btn.disabled = false;
    carregando = false;
    return;
  }

  /* ðŸš« bloqueado */
  if(user.status === "bloqueado"){
    setMsg("Conta bloqueada. Entre em contato.");
    btn.disabled = false;
    carregando = false;
    return;
  }

  /* ðŸ”‘ token de sessÃ£o */
  const token = gerarToken();

  /* ðŸ’¾ grava token */
  await sb
    .from("usuarios")
    .update({
      session_token: token,
      last_login_at: new Date().toISOString()
    })
    .eq("id", user.id);

  /* ðŸ§¾ log */
  await sb.from("login_logs").insert({
    user_id: user.id,
    email: user.email,
    user_agent: navigator.userAgent
  });

  /* ðŸ’¾ storage (PADRÃƒO DO INDEX) */
  localStorage.setItem("usuario_email", user.email);
  localStorage.setItem("session_token", token);

  setMsg("Login realizado com sucesso", "success");

  setTimeout(() => {
    location.replace("index.html");
  }, 700);
}

/* âŽ ENTER */
document.addEventListener("keydown", e => {
  if(e.key === "Enter") login();
});
</script>

</body>
</html>
