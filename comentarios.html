<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sessão • Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  background:#000;
  color:#fff;
  font-family:Inter,Arial;
  overflow:hidden
}

/* TOPO */
#top{
  position:sticky;
  top:0;
  z-index:100;
  padding:16px 20px;
  background:linear-gradient(to bottom,rgba(0,0,0,.95),rgba(0,0,0,0));
}
#top button{
  background:none;
  border:none;
  color:#fff;
  font-size:14px;
  cursor:pointer
}

/* LAYOUT */
#wrap{
  display:grid;
  grid-template-columns:1fr 380px;
  height:100%
}

/* PLAYER */
#player{
  display:flex;
  align-items:center;
  justify-content:center;
  background:#000
}
video{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* CHAT */
#chat{
  display:flex;
  flex-direction:column;
  background:linear-gradient(to bottom,#0b0b0b,#000);
  border-left:1px solid rgba(255,255,255,.12)
}
#chatHeader{
  padding:14px;
  text-align:center;
  font-weight:600;
  border-bottom:1px solid rgba(255,255,255,.12)
}
#lista{
  flex:1;
  padding:14px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px
}
.msg{
  max-width:80%;
  padding:12px;
  border-radius:14px;
  background:rgba(255,255,255,.08);
  font-size:14px
}
.msg.me{
  align-self:flex-end;
  background:#e50914
}
.msg .user{
  font-size:11px;
  opacity:.7;
  margin-bottom:4px
}
.msg .time{
  font-size:10px;
  opacity:.5;
  margin-top:6px;
  text-align:right
}
.filme-card{
  margin-top:8px;
  display:flex;
  gap:10px;
  padding:10px;
  border-radius:12px;
  background:rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.12);
  cursor:pointer
}
.filme-card img{
  width:46px;
  border-radius:6px
}

/* INPUT */
#input{
  display:flex;
  gap:10px;
  padding:12px;
  border-top:1px solid rgba(255,255,255,.12)
}
textarea{
  flex:1;
  resize:none;
  padding:10px;
  border-radius:12px;
  border:none;
  background:#111;
  color:#fff
}
button.send{
  background:#e50914;
  border:none;
  border-radius:12px;
  padding:0 16px;
  color:#fff;
  cursor:pointer
}
</style>
</head>

<body>

<div id="top">
  <button onclick="history.back()">← Voltar</button>
</div>

<div id="wrap">

  <div id="player">
    <video id="video" controls autoplay></video>
  </div>

  <div id="chat">
    <div id="chatHeader">Comentários</div>
    <div id="lista"></div>
    <div id="input">
      <textarea id="txt" placeholder="Use /Nome do Filme"></textarea>
      <button class="send" onclick="enviar()">Enviar</button>
    </div>
  </div>

</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* USUÁRIO */
const email = localStorage.getItem("usuario_email") || "anonimo@clena";

/* FILME */
const params = new URLSearchParams(location.search);
const item = JSON.parse(decodeURIComponent(params.get("item")));
const filmeId = item.id;

/* PLAYER */
video.src = item.video_url.startsWith("http")
  ? item.video_url
  : `https://sessao99.b-cdn.net/videos/${item.video_url}.m3u8`;

/* SLUG */
function slugify(t){
  return t.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/(^-|-$)/g,"");
}

/* RENDER */
function renderizar(t){
  return t.replace(
    /\{\{filme:([a-f0-9\-]+)\|(.+?)\|(.+?)\}\}/g,
    (m,id,titulo,capa)=>`
    <div class="filme-card" onclick="location.href='/${slugify(titulo)}'">
      <img src="${capa}">
      <div>
        <strong>${titulo}</strong>
        <div>Ver agora</div>
      </div>
    </div>`
  );
}

/* CARREGAR COMENTÁRIOS */
async function carregar(){
  const {data,error} = await sb
    .from("comentarios")
    .select("*")
    .eq("filme_id",filmeId)
    .order("created_at");

  if(error){
    console.error(error);
    return;
  }

  lista.innerHTML="";
  data.forEach(c=>{
    lista.innerHTML+=`
    <div class="msg ${c.email===email?"me":""}">
      <div class="user">@${c.arroba || c.email.split("@")[0]}</div>
      <div>${renderizar(c.comentario)}</div>
      <div class="time">
        ${new Date(c.created_at).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}
      </div>
    </div>`;
  });

  lista.scrollTop = lista.scrollHeight;
}

/* SERIALIZAR /FILME */
async function serializarComentario(txt){
  let out = txt;
  const matchs = [...txt.matchAll(/\/([^\n\r]+)/g)];

  for(const m of matchs){
    const nome = m[1].trim();
    const slug = slugify(nome);

    const {data} = await sb.from("filmes").select("id,titulo,capa_url");

    const filme = data?.find(f=>slugify(f.titulo)===slug);
    if(filme){
      out = out.replace(
        m[0],
        `{{filme:${filme.id}|${filme.titulo}|${filme.capa_url}}}`
      );
    }
  }
  return out;
}

/* ENVIAR */
async function enviar(){
  const v = txt.value.trim();
  if(!v) return;

  const comentarioFinal = await serializarComentario(v);

  await sb.from("comentarios").insert({
    filme_id: filmeId,
    email,
    arroba: email.split("@")[0],
    comentario: comentarioFinal
  });

  txt.value="";
  carregar();
}

carregar();
</script>

</body>
</html>
