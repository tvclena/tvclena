<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Comentários</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#0b0b0b;
  color:#fff;
  font-family:Inter,Arial;
  height:100vh;
  overflow:hidden;
}

.header{
  padding:14px;
  text-align:center;
  border-bottom:1px solid #222;
  font-size:18px;
  font-weight:600;
}

.container{
  height:100%;
  display:flex;
  flex-direction:column;
}

#lista{
  flex:1;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
}

.comment{
  max-width:75%;
  padding:12px;
  border-radius:16px;
  font-size:14px;
}

.comment.me{
  background:#e50914;
  align-self:flex-end;
}

.comment.other{
  background:#111;
  align-self:flex-start;
}

.comment .user{
  font-size:11px;
  opacity:.7;
}

.comment .time{
  font-size:10px;
  opacity:.5;
  text-align:right;
}

.comment a{
  color:#6fb7ff;
  text-decoration:none;
}

.input{
  padding:12px;
  border-top:1px solid #222;
  display:flex;
  gap:10px;
}

textarea{
  flex:1;
  background:#111;
  border:1px solid #333;
  border-radius:14px;
  padding:10px;
  color:#fff;
  resize:none;
}

button{
  background:#e50914;
  border:0;
  border-radius:14px;
  padding:10px 16px;
  color:#fff;
  cursor:pointer;
}

.autocomplete{
  position:absolute;
  bottom:80px;
  left:14px;
  right:14px;
  background:#111;
  border:1px solid #333;
  border-radius:14px;
  max-height:200px;
  overflow-y:auto;
}

.autocomplete div{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px;
  cursor:pointer;
}

.autocomplete img{
  width:40px;
  border-radius:6px;
}
</style>
</head>

<body>

<div class="header">Comentários</div>

<div class="container">
  <div id="lista"></div>

  <div class="input">
    <textarea id="txt" placeholder="Use / para marcar filmes"></textarea>
    <button onclick="enviar()">Enviar</button>
  </div>
</div>

<div id="auto" class="autocomplete" style="display:none"></div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const email = localStorage.getItem("usuario_email");
const filme_id = new URLSearchParams(location.search).get("filme_id");
let arroba = "";
let filmesCache = [];

async function init(){
  const { data:user } = await sb
    .from("usuarios")
    .select("username")
    .eq("email", email)
    .single();

  arroba = user.username;
  carregar();
}

function serializar(texto){
  return texto.replace(/\/([^\s]+)/g, (m,nome)=>{
    const f = filmesCache.find(x=>x.titulo===nome);
    if(!f) return m;
    return `{{filme:${f.id}|${f.titulo}}}`;
  });
}

function renderizar(texto){
  return texto.replace(/\{\{filme:(\d+)\|(.+?)\}\}/g,(m,id,titulo)=>{
    return `<a href="player.html?filme_id=${id}" target="_top">${titulo}</a>`;
  });
}

async function enviar(){
  const txt = document.getElementById("txt");
  const bruto = txt.value.trim();
  if(!bruto) return;

  await sb.from("comentarios").insert({
    filme_id,
    email,
    arroba,
    comentario: serializar(bruto)
  });

  txt.value="";
  carregar();
}

async function carregar(){
  const { data } = await sb
    .from("comentarios")
    .select("*")
    .eq("filme_id", filme_id)
    .order("created_at");

  const lista = document.getElementById("lista");
  lista.innerHTML="";

  data.forEach(c=>{
    lista.innerHTML += `
      <div class="comment ${c.email===email?"me":"other"}">
        <div class="user">@${c.arroba}</div>
        <div>${renderizar(c.comentario)}</div>
        <div class="time">${new Date(c.created_at).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</div>
      </div>
    `;
  });

  lista.scrollTop = lista.scrollHeight;
}

/* AUTOCOMPLETE */
document.getElementById("txt").addEventListener("input", async e=>{
  const v = e.target.value;
  const idx = v.lastIndexOf("/");
  if(idx < 0) return auto.style.display="none";

  const termo = v.slice(idx+1);
  const { data } = await sb
    .from("filmes")
    .select("id,titulo,capa_url")
    .ilike("titulo", `%${termo}%`)
    .limit(5);

  filmesCache = data || [];
  auto.innerHTML = filmesCache.map(f=>`
    <div onclick="sel('${f.titulo}')">
      <img src="${f.capa_url}">
      ${f.titulo}
    </div>
  `).join("");

  auto.style.display="block";
});

function sel(t){
  const txt = document.getElementById("txt");
  txt.value = txt.value.replace(/\/[^\s]*$/, "/"+t+" ");
  auto.style.display="none";
}

init();
</script>

</body>
</html>
