<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Comentários</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0b0b;
  --glass:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --red:#e50914;
  --blue:#2da8ff;
}

*{box-sizing:border-box}

html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  font-family:Inter,Arial;
  color:#fff;
  overflow:hidden;
}

/* GLOW LATERAL */
body::before,body::after{
  content:"";
  position:fixed;
  top:0;bottom:0;
  width:6px;
  filter:blur(14px);
  opacity:.9;
}
body::before{left:0;background:#2da8ff}
body::after{right:0;background:#e50914}

/* HEADER */
.header{
  height:64px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  backdrop-filter:blur(18px);
  background:rgba(0,0,0,.4);
  border-bottom:1px solid var(--border);
}

.header .back{
  position:absolute;
  left:14px;
  font-size:20px;
  cursor:pointer;
  opacity:.8;
}

.header .title{
  font-size:18px;
  font-weight:600;
}

.header .hint{
  position:absolute;
  bottom:6px;
  font-size:11px;
  opacity:.5;
}

/* CONTAINER */
.container{
  height:calc(100% - 64px);
  display:flex;
  flex-direction:column;
}

/* LISTA */
#lista{
  flex:1;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:14px;
  overflow-y:auto;
}

/* MSG */
.msg{
  max-width:78%;
  padding:14px;
  border-radius:18px;
  background:var(--glass);
  border:1px solid var(--border);
  backdrop-filter:blur(14px);
  position:relative;
}

.msg.me{
  align-self:flex-end;
  background:linear-gradient(135deg,#e50914aa,#a30008aa);
}

.msg .user{
  font-size:12px;
  opacity:.7;
  margin-bottom:6px;
}

.msg .time{
  font-size:10px;
  opacity:.5;
  margin-top:6px;
  text-align:right;
}

/* CARD FILME */
.filme-card{
  margin-top:10px;
  display:flex;
  gap:10px;
  padding:10px;
  border-radius:14px;
  background:rgba(0,0,0,.35);
  border:1px solid var(--border);
  cursor:pointer;
}

.filme-card img{
  width:52px;
  border-radius:8px;
}

.filme-card .info{
  display:flex;
  flex-direction:column;
  justify-content:center;
}

.filme-card .info strong{
  color:var(--blue);
}

/* INPUT */
.input{
  padding:14px;
  display:flex;
  gap:10px;
  backdrop-filter:blur(16px);
  background:rgba(0,0,0,.55);
  border-top:1px solid var(--border);
}

textarea{
  flex:1;
  background:rgba(255,255,255,.08);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  color:#fff;
  resize:none;
}

button{
  background:var(--red);
  border:none;
  border-radius:16px;
  padding:0 18px;
  color:#fff;
  cursor:pointer;
}

/* AUTOCOMPLETE */
.autocomplete{
  position:absolute;
  bottom:90px;
  left:18px;
  right:18px;
  background:#111;
  border:1px solid var(--border);
  border-radius:16px;
  max-height:220px;
  overflow-y:auto;
}

.autocomplete div{
  display:flex;
  gap:10px;
  padding:10px;
  cursor:pointer;
}

.autocomplete img{
  width:42px;
  border-radius:6px;
}
</style>
</head>

<body>

<div class="header">
  <div class="back" onclick="history.back()">←</div>
  <div class="title">Comentários</div>
  <div class="hint">Toque para ocultar os comentários</div>
</div>

<div class="container">
  <div id="lista"></div>

  <div class="input">
    <textarea id="txt" placeholder="Escreva um comentário... Use / para marcar filmes"></textarea>
    <button onclick="enviar()">Enviar</button>
  </div>
</div>

<div id="auto" class="autocomplete" style="display:none"></div>

<script>
const sb = supabase.createClient(
 "https://dxkszikemntfusfyrzos.supabase.co",
 "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const email = localStorage.getItem("usuario_email");
const filme_id = new URLSearchParams(location.search).get("filme_id");
let arroba="", cache=[];

async function init(){
 const {data:u}=await sb.from("usuarios").select("username").eq("email",email).single();
 arroba=u.username;
 carregar();
}

function serializar(t){
 return t.replace(/\/([^\s]+)/g,(m,n)=>{
  const f=cache.find(x=>x.titulo===n);
  return f?`{{filme:${f.id}|${f.titulo}|${f.capa_url}}}`:m;
 });
}

function renderizar(t){
 return t.replace(/\{\{filme:(\d+)\|(.+?)\|(.+?)\}\}/g,
  (m,id,t,c)=>`
  <div class="filme-card" onclick="window.top.location='player.html?filme_id=${id}'">
    <img src="${c}">
    <div class="info"><strong>${t}</strong><span>Ver agora</span></div>
  </div>`);
}

async function enviar(){
 const v=txt.value.trim();
 if(!v)return;
 await sb.from("comentarios").insert({
  filme_id,email,arroba,comentario:serializar(v)
 });
 txt.value="";
 carregar();
}

async function carregar(){
 const {data}=await sb.from("comentarios")
  .select("*").eq("filme_id",filme_id).order("created_at");
 lista.innerHTML="";
 data.forEach(c=>{
  lista.innerHTML+=`
   <div class="msg ${c.email===email?"me":""}">
    <div class="user">@${c.arroba}</div>
    <div>${renderizar(c.comentario)}</div>
    <div class="time">${new Date(c.created_at).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</div>
   </div>`;
 });
 lista.scrollTop=lista.scrollHeight;
}

/* AUTOCOMPLETE */
txt.addEventListener("input",async e=>{
 const i=e.target.value.lastIndexOf("/");
 if(i<0)return auto.style.display="none";
 const t=e.target.value.slice(i+1);
 const {data}=await sb.from("filmes")
  .select("id,titulo,capa_url")
  .ilike("titulo",`%${t}%`).limit(5);
 cache=data||[];
 auto.innerHTML=cache.map(f=>`
  <div onclick="sel('${f.titulo}')">
   <img src="${f.capa_url}">${f.titulo}
  </div>`).join("");
 auto.style.display="block";
});

function sel(t){
 txt.value=txt.value.replace(/\/[^\s]*$/,"/"+t+" ");
 auto.style.display="none";
}

init();
</script>

</body>
</html>
