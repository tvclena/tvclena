<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config','G-T97MS35TJ6');
</script>

<title>Sess√£o ‚Ä¢ Player</title>

<meta name="viewport" content="
  width=device-width,
  initial-scale=1.0,
  maximum-scale=1.0,
  user-scalable=no
">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  background:#000;
  color:#fff;
  font-family:Inter,Arial,sans-serif;
  touch-action:manipulation;
  overscroll-behavior:none;
}

/* TOPO */
#top{
  position:sticky;
  top:0;
  z-index:100;
  padding:16px 20px;
  background:linear-gradient(to bottom,rgba(0,0,0,.95),rgba(0,0,0,0));
}
#top button{
  background:none;
  border:none;
  color:#fff;
  font-size:15px;
  cursor:pointer;
  opacity:.85;
}

/* LAYOUT */
#layout{
  display:grid;
  grid-template-columns:3fr 1.4fr;
  min-height:100vh;
}

/* PLAYER */
#playerArea{padding:16px}
#player{
  position:sticky;
  top:80px;
  max-width:1120px;
  margin:auto;
  aspect-ratio:16/9;
  border-radius:26px;
  overflow:hidden;
  background:#000;
  box-shadow:
    0 0 70px rgba(220,38,38,.55),
    inset 0 0 50px rgba(0,0,0,.7);
}
#player video,
#player iframe{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
}

/* SIDE */
#side{
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* TITULO */
#titulo{
  font-size:28px;
  font-weight:700;
}

/* META */
#meta{
  display:flex;
  flex-wrap:wrap;
  gap:12px 22px;
  font-size:14px;
}
.meta-item{
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}
.meta-item span{opacity:.85}

/* DESCRI√á√ÉO */
#desc{
  font-size:15px;
  line-height:1.65;
  opacity:.9;
}
#desc.collapsed{
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}
#lerMais{
  background:none;
  border:none;
  color:#f87171;
  font-weight:600;
  cursor:pointer;
  align-self:flex-start;
}

/* CHAT */
#chat{
  margin-top:18px;
  border-radius:26px;
  background:#0b0b0b;
  border:1px solid #2a0f0f;
  box-shadow:0 0 35px rgba(220,38,38,.35);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#chatTop{
  padding:14px;
  text-align:center;
  font-weight:600;
  background:linear-gradient(to bottom,#1a0b0b,#0b0b0b);
  border-bottom:1px solid #2a0f0f;
}
#comentarios{
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  max-height:520px;
  overflow-y:auto;
}
.comment{
  padding:14px;
  border-radius:18px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
}
.comment .user{
  font-size:13px;
  font-weight:600;
  margin-bottom:6px;
  opacity:.85;
}
.filme-card{
  margin-top:10px;
  display:flex;
  gap:12px;
  padding:10px;
  border-radius:14px;
  background:#000;
  border:1px solid rgba(255,255,255,.15);
  cursor:pointer;
}
.filme-card img{
  width:50px;
  height:70px;
  object-fit:cover;
  border-radius:8px;
}
.filme-card strong{color:#4da3ff}

/* COMPOSER */
#composer{
  padding:14px;
  border-top:1px solid rgba(255,255,255,.15);
}
#composer textarea{
  width:100%;
  min-height:52px;
  background:#000;
  border:1px solid rgba(255,255,255,.2);
  border-radius:14px;
  padding:12px;
  color:#fff;
  resize:none;
}
#composer button{
  margin-top:10px;
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:#e50914;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

@media(max-width:900px){
  #layout{grid-template-columns:1fr}
  #player{position:relative;top:0}
}
</style>
</head>

<body>

<div id="top">
  <button onclick="history.back()">‚Üê Voltar</button>
</div>

<div id="layout">

  <div id="playerArea">
    <div id="player">
      <video id="video" controls playsinline></video>
      <iframe id="iframe" allowfullscreen allow="autoplay; fullscreen"></iframe>
    </div>
  </div>

  <div id="side">
    <h1 id="titulo"></h1>
    <div id="meta"></div>

    <p id="desc" class="collapsed"></p>
    <button id="lerMais" style="display:none">Ler mais</button>

    <!-- CHAT EMBUTIDO -->
    <div id="chat">
      <div id="chatTop">üí¨ Coment√°rios</div>
      <div id="comentarios"></div>
      <div id="composer">
        <textarea id="txt" placeholder="Escreva um coment√°rio... use / para marcar filmes"></textarea>
        <button onclick="enviar()">Enviar</button>
      </div>
    </div>

  </div>
</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ITEM */
const item = JSON.parse(
  decodeURIComponent(new URLSearchParams(location.search).get('item'))
);

const email = localStorage.getItem("usuario_email");

/* META */
titulo.textContent = item.titulo || item.serie_nome || '';
desc.textContent   = item.descricao || '';

const metas=[];
if(item.categoria) metas.push(['üé¨',item.categoria]);
if(item.tipo) metas.push(['üì∫',item.tipo]);
if(item.ano_lancamento) metas.push(['üìÖ',item.ano_lancamento]);
if(item.duracao_minutos) metas.push(['‚è±Ô∏è',item.duracao_minutos+' Min']);
if(item.idioma) metas.push(['üåé',item.idioma]);
if(item.audio) metas.push(['üîä',item.audio]);
if(item.classificacao_indicativa || item.classificacao)
  metas.push(['üîû',item.classificacao_indicativa||item.classificacao]);
if(item.nota_critica) metas.push(['‚≠ê',item.nota_critica]);

meta.innerHTML = metas.map(m =>
  `<div class="meta-item">‚úî ${m[0]} <span>${m[1]}</span></div>`
).join('');

/* LER MAIS */
setTimeout(()=>{
  if(desc.scrollHeight > desc.clientHeight)
    lerMais.style.display='inline';
},50);
lerMais.onclick=()=>desc.classList.toggle('collapsed');

/* PLAYER */
function tocar(src){
  if(!src) return;
  if(/\.m3u8$/i.test(src)){
    iframe.remove();
    video.src=src;
    video.play().catch(()=>{});
  }else{
    video.remove();
    iframe.src=`https://iframe.mediadelivery.net/embed/569072/${src}`;
  }
}
tocar(item.video_url);

/* RENDER FILME NO CHAT */
function renderizar(txt){
  return txt.replace(
    /\{\{filme:([a-f0-9\-]+)\|(.+?)\|(.+?)\}\}/g,
    (m,id,titulo,capa)=>`
      <div class="filme-card">
        <img src="${capa}">
        <div><strong>${titulo}</strong></div>
      </div>
    `
  );
}

/* CARREGAR COMENT√ÅRIOS */
async function carregar(){
  const {data}=await sb
    .from("comentarios")
    .select("*")
    .eq("filme_id",item.id)
    .order("created_at",{ascending:false});

  comentarios.innerHTML="";
  data?.forEach(c=>{
    comentarios.innerHTML+=`
      <div class="comment">
        <div class="user">@${c.arroba}</div>
        <div>${renderizar(c.comentario)}</div>
      </div>
    `;
  });
}
carregar();

/* ENVIAR */
async function enviar(){
  const v=txt.value.trim();
  if(!v) return;
  await sb.from("comentarios").insert({
    filme_id:item.id,
    email,
    arroba:email,
    comentario:v
  });
  txt.value="";
  carregar();
}
</script>

<script>
/* üîí BLOQUEIO TOTAL DE ZOOM */
window.addEventListener('wheel',e=>{if(e.ctrlKey)e.preventDefault()},{passive:false});
window.addEventListener('keydown',e=>{
  if(e.ctrlKey && ['+','-','=','0'].includes(e.key)) e.preventDefault();
});
window.addEventListener('gesturestart',e=>e.preventDefault());
window.addEventListener('gesturechange',e=>e.preventDefault());
window.addEventListener('gestureend',e=>e.preventDefault());
</script>

</body>
</html>
