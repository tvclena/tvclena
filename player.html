<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config','G-T97MS35TJ6',{debug_mode:true});
</script>

<title>Sess√£o ‚Ä¢ Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#000;
  color:#fff;
  font-family:Inter,Arial,sans-serif;
  overflow-y:auto;
}

/* ===== TOPO ===== */
#topActions{
  position:sticky;
  top:0;
  z-index:50;
  padding:14px;
  background:linear-gradient(to bottom,rgba(0,0,0,.85),rgba(0,0,0,0));
}
.topBtn{
  background:rgba(0,0,0,.6);
  border:none;
  color:#fff;
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
}

/* ===== LAYOUT ===== */
#layout{
  display:grid;
  grid-template-columns:3fr 1.4fr;
  min-height:100vh;
}

/* ===== PLAYER ===== */
#playerArea{
  padding:16px;
}
.playerWrapper{
  width:100%;
  max-width:1100px;
  margin:auto;
  aspect-ratio:16/9;
  position:sticky;
  top:60px;
  border-radius:18px;
  overflow:hidden;
  background:#000;
}
.playerWrapper video,
.playerWrapper iframe{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
}

/* ===== SIDE ===== */
#side{
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* ===== INFO CARDS ===== */
.info-cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(110px,1fr));
  gap:10px;
}
.info-card{
  background:#121212;
  border:1px solid #2a2a2a;
  border-radius:14px;
  padding:10px;
}
.info-card span{
  font-size:11px;
  opacity:.6;
}
.info-card strong{
  font-size:13px;
  font-weight:600;
}

/* ===== DESCRI√á√ÉO ===== */
.desc{
  font-size:14px;
  opacity:.85;
  line-height:1.5;
}
.desc.collapsed{
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}
.ler-mais{
  background:none;
  border:none;
  color:#e50914;
  font-weight:600;
  cursor:pointer;
  align-self:flex-start;
}

/* ===== CHAT ===== */
#chatContainer{
  border:2px solid #e50914;
  border-radius:22px;
  padding:10px;
  height:420px;
  background:#0b0b0b;
  display:flex;
  flex-direction:column;
}
#chatHeader{
  font-size:14px;
  font-weight:600;
  margin-bottom:6px;
}
#comentariosIframe{
  flex:1;
  border:0;
  border-radius:16px;
  background:#fff;
}

/* ===== MOBILE ===== */
@media(max-width:900px){
  #layout{grid-template-columns:1fr}
  .playerWrapper{position:relative;top:0}
  #chatContainer{height:360px}
}
</style>
</head>

<body>

<div id="topActions">
  <button class="topBtn" onclick="voltar()">‚Üê Voltar</button>
</div>

<div id="layout">

  <!-- PLAYER -->
  <div id="playerArea">
    <div class="playerWrapper">
      <video id="video" controls playsinline></video>
      <iframe id="iframe" allowfullscreen allow="autoplay; fullscreen"></iframe>
    </div>
  </div>

  <!-- SIDE -->
  <div id="side">

    <h2 id="titulo"></h2>

    <div id="infoCards" class="info-cards"></div>

    <p id="desc" class="desc collapsed"></p>
    <button id="lerMaisBtn" class="ler-mais" style="display:none">Ler mais</button>

    <!-- CHAT -->
    <div id="chatContainer">
      <div id="chatHeader">üí¨ Chat</div>
      <iframe id="comentariosIframe"></iframe>
    </div>

  </div>

</div>

<script>
/* ===== VOLTAR ===== */
function voltar(){
  if(history.length>1) history.back();
  else location.href='index.html';
}

/* ===== PAUSAR AO SUBIR ===== */
let lastScroll=0;
window.addEventListener('scroll',()=>{
  const atual=window.scrollY;
  if(atual < lastScroll && video && !video.paused){
    video.pause();
  }
  lastScroll=atual;
});

/* ===== ITEM ===== */
const item = JSON.parse(
  decodeURIComponent(new URLSearchParams(location.search).get("item"))
);

/* ===== UI ===== */
titulo.textContent=item.titulo||item.serie_nome||'Conte√∫do';
desc.textContent=item.descricao||'';

infoCards.innerHTML=`
${item.categoria?`<div class="info-card"><span>Categoria</span><strong>${item.categoria}</strong></div>`:''}
${item.tipo?`<div class="info-card"><span>Tipo</span><strong>${item.tipo}</strong></div>`:''}
${item.ano_lancamento?`<div class="info-card"><span>Ano</span><strong>${item.ano_lancamento}</strong></div>`:''}
${item.duracao_minutos?`<div class="info-card"><span>Dura√ß√£o</span><strong>${item.duracao_minutos} min</strong></div>`:''}
${item.idioma?`<div class="info-card"><span>Idioma</span><strong>${item.idioma}</strong></div>`:''}
${item.audio?`<div class="info-card"><span>√Åudio</span><strong>${item.audio}</strong></div>`:''}
${item.classificacao_indicativa?`<div class="info-card"><span>Classifica√ß√£o</span><strong>+${item.classificacao_indicativa}</strong></div>`:''}
${item.nota_critica?`<div class="info-card"><span>Nota</span><strong>‚≠ê ${item.nota_critica}</strong></div>`:''}
`;

/* Ler mais */
setTimeout(()=>{
  if(desc.scrollHeight>desc.clientHeight){
    lerMaisBtn.style.display='inline';
  }
},50);

lerMaisBtn.onclick=()=>{
  const aberto=!desc.classList.contains('collapsed');
  desc.classList.toggle('collapsed',aberto);
  lerMaisBtn.textContent=aberto?'Ler mais':'Ler menos';
};

/* ===== CHAT ===== */
comentariosIframe.src=
  `comentarios.html?filme_id=${item.id||item.video_url}&tipo=${item.tipo}`;

/* ===== PLAYER ===== */
function tocarFonte(src){
  if(/\.m3u8$/i.test(src)){
    iframe.remove();
    video.src=src;
    video.play().catch(()=>{});
  }else{
    video.remove();
    iframe.src=src.includes('mediadelivery')
      ? src
      : `https://iframe.mediadelivery.net/embed/569072/${src}`;
  }
}
tocarFonte(item.video_url);
</script>

</body>
</html>
