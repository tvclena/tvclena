<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<!-- ================= GA4 ================= -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config','G-T97MS35TJ6',{debug_mode:true});
</script>

<title>Sess√£o ‚Ä¢ Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{background:#000;color:#fff;font-family:Inter,Arial,sans-serif}

/* ===== TOPO ===== */
#top{
  position:sticky;top:0;z-index:100;
  padding:16px 20px;
  background:linear-gradient(to bottom,rgba(0,0,0,.95),rgba(0,0,0,0));
}
#top button{
  background:none;border:none;color:#fff;
  font-size:15px;cursor:pointer;opacity:.85;
}
#top button:hover{opacity:1}

/* ===== LAYOUT ===== */
#layout{
  display:grid;
  grid-template-columns:3fr 1.4fr;
  min-height:100vh;
}

/* ===== PLAYER ===== */
#playerArea{padding:16px}
#player{
  position:sticky;top:80px;
  max-width:1120px;margin:auto;
  aspect-ratio:16/9;
  border-radius:26px;
  overflow:hidden;background:#000;
  box-shadow:0 0 60px rgba(0,140,255,.35);
}
#player video,#player iframe{
  position:absolute;inset:0;width:100%;height:100%;border:0;
}

/* ===== SIDE ===== */
#side{
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* ===== TITULO ===== */
#titulo{font-size:28px;font-weight:700}

/* ===== META EM LINHA ===== */
#meta{
  display:flex;flex-wrap:wrap;
  gap:14px 22px;font-size:14px;opacity:.9;
}
.meta-item{display:flex;align-items:center;gap:6px;white-space:nowrap}
.meta-item span{opacity:.7}

/* ===== DESCRI√á√ÉO ===== */
#desc{font-size:15px;line-height:1.65;opacity:.85}
#desc.collapsed{
  display:-webkit-box;-webkit-line-clamp:3;
  -webkit-box-orient:vertical;overflow:hidden;
}
#lerMais{
  background:none;border:none;color:#4da3ff;
  font-weight:600;cursor:pointer;
}

/* ===== CHAT ===== */
#chat{
  margin-top:10px;height:680px;
  border-radius:26px;overflow:hidden;
  background:#0b0b0b;border:1px solid #1f1f1f;
  display:flex;flex-direction:column;
}
#chatTop{
  padding:14px;text-align:center;
  font-weight:600;cursor:pointer;
  background:#111;border-bottom:1px solid #222;
}
#chat iframe{flex:1;border:0;background:#fff}

/* ===== MOBILE ===== */
@media(max-width:900px){
  #layout{grid-template-columns:1fr}
  #player{position:relative;top:0}
  #chat{height:85vh}
}
</style>
</head>

<body>

<div id="top">
  <button onclick="voltar()">‚Üê Voltar</button>
</div>

<div id="layout">

  <!-- PLAYER -->
  <div id="playerArea">
    <div id="player">
      <video id="video" controls playsinline></video>
      <iframe id="iframe" allowfullscreen allow="autoplay; fullscreen"></iframe>
    </div>
  </div>

  <!-- SIDE -->
  <div id="side">

    <h1 id="titulo"></h1>
    <div id="meta"></div>

    <p id="desc" class="collapsed"></p>
    <button id="lerMais" style="display:none">Ler mais</button>

    <div id="chat">
      <div id="chatTop" onclick="subir()">‚¨ÜÔ∏è Voltar para o player</div>
      <iframe id="comentariosIframe"></iframe>
    </div>

  </div>
</div>

<script>
/* ===== ITEM ===== */
const item = JSON.parse(
  decodeURIComponent(new URLSearchParams(location.search).get('item'))
);

/* ===== HELPERS ===== */
function meta(icon,value){
  return value?`<div class="meta-item">${icon} <span>${value}</span></div>`:'';
}

/* ===== UI ===== */
titulo.textContent = item.titulo || item.serie_nome || 'Conte√∫do';
desc.textContent   = item.descricao || '';

meta.innerHTML = `
${meta('üé¨',item.categoria)}
${meta('üì∫',item.tipo)}
${meta('üìÖ',item.ano_lancamento)}
${meta('üìÄ',item.serie_nome)}
${meta('üì¶',item.temporada && 'Temporada '+item.temporada)}
${meta('‚ñ∂Ô∏è',item.episodio && 'Epis√≥dio '+item.episodio)}
${meta('‚è±Ô∏è',item.duracao_minutos && item.duracao_minutos+' min')}
${meta('üåé',item.idioma)}
${meta('üîä',item.audio)}
${meta('üîû',item.classificacao_indicativa)}
${meta('‚≠ê',item.nota_critica)}
`;

/* ===== GA4 VIEW CONTENT ===== */
gtag('event','view_content',{
  content_type:item.tipo,
  item_id:item.id,
  item_name:titulo.textContent,
  category:item.categoria,
  year:item.ano_lancamento
});

/* ===== LER MAIS ===== */
setTimeout(()=>{
  if(desc.scrollHeight>desc.clientHeight){
    lerMais.style.display='inline';
  }
},50);
lerMais.onclick=()=>{
  desc.classList.toggle('collapsed');
};

/* ===== CHAT ===== */
comentariosIframe.src =
  `comentarios.html?filme_id=${item.id}&tipo=${item.tipo}`;

/* ===== PLAYER ===== */
function tocar(src){
  if(/\.m3u8$/i.test(src)){
    iframe.remove();
    video.src=src;
    video.addEventListener('play',()=> {
      gtag('event','play',{
        item_name:titulo.textContent,
        item_type:item.tipo
      });
    },{once:true});
    video.play().catch(()=>{});
  }else{
    video.remove();
    iframe.src=`https://iframe.mediadelivery.net/embed/569072/${src}`;
  }
}
tocar(item.video_url);

/* ===== NAV ===== */
function voltar(){history.back()}
function subir(){
  document.getElementById('player')
    .scrollIntoView({behavior:'smooth'});
}
</script>

</body>
</html>
