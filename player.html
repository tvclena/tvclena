<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sess√£o ‚Ä¢ Player</title>

<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  background:#000;
  color:#fff;
  font-family:Inter,Arial,sans-serif;
}

/* TOPO */
#top{
  position:sticky;
  top:0;
  z-index:100;
  padding:16px 20px;
  background:linear-gradient(to bottom,rgba(0,0,0,.95),rgba(0,0,0,0));
}
#top button{
  background:none;
  border:none;
  color:#fff;
  font-size:15px;
  cursor:pointer;
}

/* LAYOUT */
#layout{
  display:grid;
  grid-template-columns:3fr 1.4fr;
  min-height:100vh;
}

/* PLAYER */
#playerArea{padding:16px}
#player{
  position:sticky;
  top:80px;
  max-width:1120px;
  margin:auto;
  aspect-ratio:16/9;
  border-radius:26px;
  overflow:hidden;
  background:#000;
  box-shadow:0 0 70px rgba(220,38,38,.55);
}
#player video,
#player iframe{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
}

/* SIDE */
#side{
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* TITULO */
#titulo{
  font-size:28px;
  font-weight:700;
}

/* META */
#meta{
  display:flex;
  flex-wrap:wrap;
  gap:12px 22px;
  font-size:14px;
}
.meta-item{
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}
.meta-item span{opacity:.85}

/* ESTRELAS */
.stars{
  color:#facc15;
  font-size:15px;
  letter-spacing:1px;
}

/* AVALIAR */
#avaliarBox{
  margin-top:6px;
}
.avaliar-label{
  font-size:13px;
  opacity:.7;
  margin-bottom:6px;
}
.avaliar-stars{
  display:flex;
  gap:6px;
  font-size:24px;
  cursor:pointer;
}
.avaliar-stars span{
  color:#444;
  transition:.2s;
}
.avaliar-stars span.active{
  color:#facc15;
}

/* DESCRI√á√ÉO */
#desc{
  font-size:15px;
  line-height:1.65;
  opacity:.9;
}
#desc.collapsed{
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* LER MAIS */
#lerMais{
  background:none;
  border:none;
  color:#f87171;
  font-weight:600;
  cursor:pointer;
  align-self:flex-start;
}

@media(max-width:900px){
  #layout{grid-template-columns:1fr}
  #player{position:relative;top:0}
}
</style>
</head>

<body>

<div id="top">
  <button onclick="history.back()">‚Üê Voltar</button>
</div>

<div id="layout">

  <div id="playerArea">
    <div id="player">
      <video id="video" controls playsinline></video>
      <iframe id="iframe" allowfullscreen allow="autoplay; fullscreen"></iframe>
    </div>
  </div>

  <div id="side">
    <h1 id="titulo"></h1>
    <div id="meta"></div>

    <!-- AVALIA√á√ÉO DO USU√ÅRIO -->
    <div id="avaliarBox">
      <div class="avaliar-label">Avalie este conte√∫do</div>
      <div id="avaliarStars" class="avaliar-stars"></div>
    </div>

    <p id="desc" class="collapsed"></p>
    <button id="lerMais" style="display:none">Ler mais</button>
  </div>

</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ITEM */
const item = JSON.parse(
  decodeURIComponent(new URLSearchParams(location.search).get('item'))
);

/* ESTRELAS (ASSINANTES) */
function estrelasMedia(media){
  if(media === null) return '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
  const q = Math.round(media / 2);
  let out='';
  for(let i=1;i<=5;i++) out += i<=q ? '‚≠ê' : '‚òÜ';
  return `<span class="stars">${out}</span>`;
}

/* RENDER ESTRELAS AVALIA√á√ÉO */
function renderAvaliarStars(valor=0){
  const box = document.getElementById('avaliarStars');
  box.innerHTML = '';
  const q = Math.round(valor / 2);

  for(let i=1;i<=5;i++){
    const s = document.createElement('span');
    s.textContent = '‚òÖ';
    if(i<=q) s.classList.add('active');
    s.onclick = ()=> salvarAvaliacao(i*2);
    box.appendChild(s);
  }
}

/* SALVAR AVALIA√á√ÉO */
async function salvarAvaliacao(nota){
  const user = (await sb.auth.getUser()).data.user;
  if(!user){
    alert("Fa√ßa login para avaliar");
    return;
  }

  await sb.from('avaliacoes').upsert({
    filme_id: item.id,
    usuario_id: user.id,
    nota
  }, { onConflict:'filme_id,usuario_id' });

  carregar(); // atualiza m√©dia
}

/* PLAYER */
function tocar(src){
  if(!src) return;
  if(/\.m3u8$/i.test(src)){
    iframe.remove();
    video.src = src;
    video.play().catch(()=>{});
  }else{
    video.remove();
    iframe.src = `https://iframe.mediadelivery.net/embed/569072/${src}`;
  }
}

/* CARREGAR TUDO */
async function carregar(){
  /* FILME */
  const { data: filme } = await sb
    .from("filmes")
    .select("*")
    .eq("id", item.id)
    .single();

  if(!filme){
    titulo.textContent = "Conte√∫do n√£o encontrado";
    return;
  }

  /* M√âDIA ASSINANTES */
  const { data: avals } = await sb
    .from("avaliacoes")
    .select("nota")
    .eq("filme_id", item.id);

  let media = null;
  if(avals?.length){
    media = avals.reduce((t,a)=>t+a.nota,0)/avals.length;
  }

  /* AVALIA√á√ÉO DO USU√ÅRIO */
  const user = (await sb.auth.getUser()).data.user;
  if(user){
    const { data: minha } = await sb
      .from("avaliacoes")
      .select("nota")
      .eq("filme_id", item.id)
      .eq("usuario_id", user.id)
      .single();

    renderAvaliarStars(minha?.nota || 0);
  }

  /* T√çTULO / DESCRI√á√ÉO */
  titulo.textContent = filme.titulo;
  desc.textContent   = filme.descricao || "";

  /* META */
  const metas=[];
  if(filme.categoria) metas.push(['üé¨',filme.categoria]);
  if(filme.tipo) metas.push(['üì∫',filme.tipo]);
  if(filme.ano_lancamento) metas.push(['üìÖ',filme.ano_lancamento]);
  if(filme.idioma) metas.push(['üåé',filme.idioma]);
  if(filme.audio) metas.push(['üîä',filme.audio]);
  if(filme.classificacao_indicativa || filme.classificacao)
    metas.push(['üîû',filme.classificacao_indicativa || filme.classificacao]);

  if(filme.nota_critica)
    metas.push(['‚≠ê',filme.nota_critica + ' ‚Ä¢ Cr√≠tica']);

  if(media !== null)
    metas.push(['üë•',estrelasMedia(media) + ' ‚Ä¢ Assinantes']);

  meta.innerHTML = metas.map(m =>
    `<div class="meta-item">${m[0]} <span>${m[1]}</span></div>`
  ).join('');

  /* LER MAIS */
  setTimeout(()=>{
    if(desc.scrollHeight > desc.clientHeight){
      lerMais.style.display='inline';
      lerMais.textContent='Ler mais';
    }
  },50);

  lerMais.onclick = ()=>{
    const fechado = desc.classList.toggle('collapsed');
    lerMais.textContent = fechado ? 'Ler mais' : 'Ler menos';
  };

  tocar(filme.video_url);
}

carregar();
</script>

</body>
</html>
