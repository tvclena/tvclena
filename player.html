<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sess√£o ‚Ä¢ Player</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{background:#000;color:#fff;font-family:Inter,Arial}

/* TOPO */
#top{
  position:sticky;top:0;z-index:100;
  padding:16px 20px;
  background:linear-gradient(to bottom,rgba(0,0,0,.95),rgba(0,0,0,0))
}
#top button{
  background:none;border:none;color:#fff;
  font-size:15px;cursor:pointer
}

/* LAYOUT */
#layout{
  display:grid;
  grid-template-columns:3fr 1.4fr;
  min-height:100vh
}
@media(max-width:900px){
  #layout{grid-template-columns:1fr}
  #player{position:relative;top:0}
}

/* PLAYER */
#playerArea{padding:16px}
#player{
  position:sticky;top:80px;
  max-width:1120px;margin:auto;
  aspect-ratio:16/9;
  border-radius:26px;
  overflow:hidden;
  background:#000;
  box-shadow:0 0 70px rgba(220,38,38,.55)
}
#player video,#player iframe{
  position:absolute;inset:0;
  width:100%;height:100%;border:0
}

/* SIDE */
#side{
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:14px
}
#titulo{font-size:28px;font-weight:700}

/* META */
#meta{
  display:flex;
  flex-wrap:wrap;
  gap:12px 22px;
  font-size:14px
}
.meta-item{
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap
}
.meta-item span{opacity:.85}

/* AVALIA√á√ÉO */
#avaliarBox{margin-top:6px}
.avaliar-label{
  font-size:13px;
  opacity:.7;
  margin-bottom:6px
}
.avaliar-stars{
  display:flex;
  gap:8px;
  font-size:26px;
  cursor:pointer
}
.avaliar-stars span{
  color:#333;
  transition:.2s
}
.avaliar-stars span.active,
.avaliar-stars span.hover{
  color:#facc15;
  transform:scale(1.08)
}

/* DESCRI√á√ÉO */
#desc{
  font-size:15px;
  line-height:1.65;
  opacity:.9
}
#desc.collapsed{
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden
}
#lerMais{
  background:none;
  border:none;
  color:#f87171;
  font-weight:600;
  cursor:pointer;
  align-self:flex-start
}

/* SELECTS */
#selectorsBox{
  display:flex;
  gap:12px;
  margin-top:18px
}
#selectorsBox select{
  flex:1;
  padding:12px 14px;
  border-radius:14px;
  background:#111;
  border:1px solid #333;
  color:#fff;
  font-weight:600;
  cursor:pointer
}
#selectorsBox select:focus{
  outline:none;
  border-color:#dc2626
}
</style>
</head>

<body>

<div id="top">
  <button onclick="voltarHome()">‚Üê Voltar</button>
</div>

<div id="layout">

  <div id="playerArea">
    <div id="player">
      <video id="video" controls playsinline></video>
      <iframe id="iframe" allowfullscreen allow="autoplay; fullscreen"></iframe>
    </div>
  </div>

  <div id="side">
    <h1 id="titulo"></h1>
    <div id="meta"></div>

    <!-- ‚≠ê AVALIA√á√ÉO -->
    <div id="avaliarBox">
      <div class="avaliar-label">Avalie este conte√∫do</div>
      <div id="avaliarStars" class="avaliar-stars"></div>
    </div>

    <!-- üì∫ SELECTS (S√ì S√âRIE) -->
    <div id="selectorsBox">
      <select id="temporadaSelect"></select>
      <select id="episodioSelect"></select>
    </div>

    <p id="desc" class="collapsed"></p>
    <button id="lerMais" style="display:none">Ler mais</button>
  </div>

</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ================= ELEMENTOS ================= */
const video = document.getElementById("video");
const iframe = document.getElementById("iframe");
const titulo = document.getElementById("titulo");
const meta = document.getElementById("meta");
const desc = document.getElementById("desc");
const lerMais = document.getElementById("lerMais");
const avaliarStars = document.getElementById("avaliarStars");
const temporadaSelect = document.getElementById("temporadaSelect");
const episodioSelect = document.getElementById("episodioSelect");

/* ================= DADOS ================= */
const item = JSON.parse(
  decodeURIComponent(new URLSearchParams(location.search).get("item"))
);

let usuario = null;
let authReady = false;
let temporadaAtual = null;
let episodios = [];

/* ================= LOGIN ================= */
async function carregarUsuario(){
  // tentativa imediata
  const { data:{ session } } = await sb.auth.getSession();

  if(session?.user?.email){
    await carregarPerfil(session.user.email);
    authReady = true;
    return;
  }

  // fallback correto
  sb.auth.onAuthStateChange(async (_event, session)=>{
    if(session?.user?.email){
      await carregarPerfil(session.user.email);
    }
    authReady = true;
  });
}

/* ================= PLAYER ================= */
function tocar(src){
  if(!src) return;

  video.pause();
  iframe.src="";

  if(/\.m3u8$/i.test(src)){
    iframe.style.display="none";
    video.style.display="block";
    video.src = src;
    video.muted = true;
    video.play().then(()=>video.muted=false).catch(()=>{});
  }else{
    video.style.display="none";
    iframe.style.display="block";
    iframe.src = `https://iframe.mediadelivery.net/embed/569072/${src}`;
  }
}

/* ================= AVALIA√á√ÉO ================= */
function renderStars(nota=0){
  avaliarStars.innerHTML="";
  const fixas=Math.round(nota/2);

  for(let i=1;i<=5;i++){
    const s=document.createElement("span");
    s.textContent="‚òÖ";
    if(i<=fixas)s.classList.add("active");
    s.onmouseenter=()=>hoverStars(i);
    s.onmouseleave=()=>hoverStars(fixas);
    s.onclick=()=>salvarAvaliacao(i*2);
    avaliarStars.appendChild(s);
  }
}
function hoverStars(q){
  [...avaliarStars.children].forEach((s,i)=>{
    s.classList.toggle("hover",i<q);
  });
}
async function salvarAvaliacao(nota){
  // ‚è≥ sess√£o ainda carregando
  if(!authReady){
    alert("Aguarde a sess√£o carregar");
    return;
  }

  // üîê n√£o logado
  if(!usuario){
    alert("Fa√ßa login para avaliar");
    return;
  }

  await sb.from("avaliacoes").upsert({
    filme_id: item.id,
    usuario_id: usuario.id,
    nota
  });

  renderStars(nota);
}
async function carregarPerfil(email){
  const { data, error } = await sb
    .from("usuarios")
    .select("id,email")
    .eq("email", email)
    .maybeSingle();

  if(error){
    console.error("Erro ao carregar perfil:", error);
    return;
  }

  if(data){
    usuario = data;
  }
}


/* ================= LOAD ================= */
async function carregar(){
  const { data: filme } = await sb
    .from("filmes")
    .select("*")
    .eq("id", item.id)
    .single();

  titulo.textContent = filme.titulo || filme.serie_nome;
  desc.textContent = filme.descricao || "";

  /* ‚≠ê avalia√ß√µes */
  const { data: avals } = await sb
    .from("avaliacoes")
    .select("nota")
    .eq("filme_id", item.id);

  let media = 0;
  if(avals?.length){
    media = avals.reduce((t,a)=>t+a.nota,0)/avals.length;
  }

  if(usuario){
    const { data:minha } = await sb
      .from("avaliacoes")
      .select("nota")
      .eq("filme_id", item.id)
      .eq("usuario_id", usuario.id)
      .maybeSingle();
    renderStars(minha?.nota || media);
  }else{
    renderStars(media);
  }

  /* meta */
  const metas=[];
  if(filme.categoria) metas.push(`üé¨ ${filme.categoria}`);
  if(filme.tipo) metas.push(`üì∫ ${filme.tipo}`);
  if(filme.ano_lancamento) metas.push(`üìÖ ${filme.ano_lancamento}`);
  if(filme.idioma) metas.push(`üåé ${filme.idioma}`);
  if(filme.audio) metas.push(`üîä ${filme.audio}`);
  if(filme.classificacao) metas.push(`üîû ${filme.classificacao}`);
  if(filme.nota_critica) metas.push(`‚≠ê ${filme.nota_critica} ‚Ä¢ Cr√≠tica`);
  if(media) metas.push(`üë• ${"‚òÖ".repeat(Math.round(media/2))} ‚Ä¢ Assinantes`);

  meta.innerHTML = metas.map(m =>
    `<div class="meta-item"><span>${m}</span></div>`
  ).join("");

  /* filme ou s√©rie */
  if(filme.tipo === "serie"){
    await carregarEpisodios();
  }else{
    temporadaSelect.style.display="none";
    episodioSelect.style.display="none";
    tocar(filme.video_url);
  }

  if(desc.scrollHeight > desc.clientHeight){
    lerMais.style.display="inline";
    lerMais.onclick=()=>{
      desc.classList.toggle("collapsed");
      lerMais.textContent =
        desc.classList.contains("collapsed") ? "Ler mais" : "Ler menos";
    };
  }
}

/* ================= S√âRIES ================= */
async function carregarEpisodios(){
  const { data } = await sb
    .from("filmes")
    .select("*")
    .eq("tipo","serie")
    .eq("serie_nome", item.serie_nome)
    .order("temporada",{ascending:true})
    .order("episodio",{ascending:true});

  episodios = data || [];
  if(!episodios.length) return;

  const temporadas = [...new Set(episodios.map(e=>e.temporada))];
  temporadaSelect.innerHTML = temporadas.map(t =>
    `<option value="${t}">Temporada ${t}</option>`
  ).join("");

  temporadaAtual = temporadas[0];
  temporadaSelect.onchange=()=>{
    temporadaAtual = Number(temporadaSelect.value);
    renderEpisodios();
  };

  renderEpisodios();
}
function renderEpisodios(){
  const lista = episodios.filter(e=>e.temporada===temporadaAtual);
  episodioSelect.innerHTML = lista.map(e =>
    `<option value="${e.video_url}">Epis√≥dio ${e.episodio}</option>`
  ).join("");

  episodioSelect.onchange=()=>tocar(episodioSelect.value);
  if(lista.length) tocar(lista[0].video_url);
}

/* ================= NAV ================= */
function voltarHome(){
  location.href="index.html";
}

/* ================= INIT ================= */
(async()=>{
  await carregarUsuario();
  carregar();
})();
</script>

</body>
</html>
