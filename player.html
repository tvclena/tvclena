<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sess√£o ‚Ä¢ Player</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config','G-T97MS35TJ6');
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  background:#000;
  color:#fff;
  font-family:Inter,Arial,sans-serif;
}

/* REMOVE FAIXA PRETA MOBILE */
body{
  padding-top:env(safe-area-inset-top);
}

/* TOPO */
#top{
  position:sticky;
  top:0;
  z-index:100;
  padding:14px 20px;
  background:linear-gradient(to bottom,rgba(0,0,0,.9),rgba(0,0,0,0));
}
#top button{
  background:none;border:none;color:#fff;
  font-size:15px;cursor:pointer;opacity:.9;
}

/* LAYOUT */
#layout{
  display:grid;
  grid-template-columns:3fr 1.4fr;
  min-height:100vh;
}

/* PLAYER */
#playerArea{padding:16px}
#player{
  position:relative;
  max-width:1120px;
  margin:auto;
  aspect-ratio:16/9;
  border-radius:26px;
  overflow:hidden;
  background:#000;
  box-shadow:
    0 0 90px rgba(220,38,38,.6),
    inset 0 0 60px rgba(0,0,0,.7);
}
#player::before{
  content:"";
  position:absolute;
  inset:-70px;
  background:radial-gradient(circle,
    rgba(220,38,38,.45),
    rgba(0,0,0,0) 70%);
  z-index:-1;
}
#player video,
#player iframe{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
}

/* SIDE */
#side{
  padding:22px 22px 30px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* TITULO */
#titulo{
  font-size:28px;
  font-weight:700;
}

/* META EM LINHA */
#meta{
  display:flex;
  flex-wrap:wrap;
  gap:14px 22px;
  font-size:14px;
}
.meta-item{
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
  opacity:.85;
}

/* DESCRI√á√ÉO */
#desc{
  font-size:15px;
  line-height:1.65;
  opacity:.9;
}
#desc.collapsed{
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}
#lerMais{
  background:none;
  border:none;
  color:#f87171;
  font-weight:600;
  cursor:pointer;
}

/* CHAT */
#chat{
  margin-top:10px;
  height:640px;
  border-radius:26px;
  overflow:hidden;
  background:#0b0b0b;
  border:1px solid #2a0f0f;
  box-shadow:0 0 30px rgba(220,38,38,.35);
  display:flex;
  flex-direction:column;
}
#chatTop{
  padding:14px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  background:linear-gradient(to bottom,#1a0b0b,#0b0b0b);
  border-bottom:1px solid #2a0f0f;
}
#chat iframe{
  flex:1;
  border:0;
  background:#fff;
}

@media(max-width:900px){
  #layout{grid-template-columns:1fr}
  #chat{height:80vh}
}
</style>
</head>

<body>

<div id="top">
  <button onclick="history.back()">‚Üê Voltar</button>
</div>

<div id="layout">

  <div id="playerArea">
    <div id="player">
      <video id="video" controls playsinline></video>
      <iframe id="iframe" allowfullscreen allow="autoplay; fullscreen"></iframe>
    </div>
  </div>

  <div id="side">
    <h1 id="titulo"></h1>
    <div id="meta"></div>

    <p id="desc" class="collapsed"></p>
    <button id="lerMais" style="display:none">Ler mais</button>

    <div id="chat">
      <div id="chatTop" onclick="player.scrollIntoView({behavior:'smooth'})">
        ‚¨ÜÔ∏è Voltar para o player
      </div>
      <iframe id="comentariosIframe"></iframe>
    </div>
  </div>

</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const { createClient } = supabase;

// üîë CONFIG (SUBSTITUA)
const SUPABASE_URL = 'SUA_SUPABASE_URL';
const SUPABASE_KEY = 'SUA_ANON_KEY';

const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

// üîé ID
const id = new URLSearchParams(location.search).get('id');
if(!id){
  alert('ID n√£o informado');
  throw new Error('ID n√£o informado');
}

// üîß RAW_INFO
function extrair(raw, regex){
  if(!raw) return null;
  const m = raw.match(regex);
  return m ? m[1].trim() : null;
}

// ‚ñ∂Ô∏è PLAYER
function tocar(src){
  if(!src) return;
  if(/\.m3u8$/i.test(src)){
    iframe.remove();
    video.src = src;
    video.play().catch(()=>{});
  } else {
    video.remove();
    iframe.src = `https://iframe.mediadelivery.net/embed/569072/${src}`;
  }
}

// üéØ RENDER
function render(item){
  titulo.textContent = item.titulo || item.serie_nome || 'Conte√∫do';
  desc.textContent = item.descricao || '';

  const metas = [];
  if(item.categoria) metas.push(['üé¨',item.categoria]);
  if(item.tipo) metas.push(['üì∫',item.tipo]);
  if(item.ano_lancamento) metas.push(['üìÖ',item.ano_lancamento]);
  if(item.idioma) metas.push(['üåé',item.idioma]);
  if(item.audio) metas.push(['üîä',item.audio]);
  if(item.classificacao_indicativa) metas.push(['üîû',item.classificacao_indicativa]);
  if(item.nota_critica) metas.push(['‚≠ê',item.nota_critica]);

  const qualidade = extrair(item.raw_info,/Qualidade:\s*([^\n]+)/i);
  const formato = extrair(item.raw_info,/Formato:\s*([^\n]+)/i);
  const tamanho = extrair(item.raw_info,/Tamanho:\s*([^\n]+)/i);

  if(qualidade) metas.push(['üéûÔ∏è',qualidade]);
  if(formato) metas.push(['üì¶',formato]);
  if(tamanho) metas.push(['üíæ',tamanho]);

  meta.innerHTML = metas.map(
    m=>`<div class="meta-item">${m[0]} ${m[1]}</div>`
  ).join('');

  setTimeout(()=>{
    if(desc.scrollHeight > desc.clientHeight){
      lerMais.style.display='inline';
    }
  },50);

  lerMais.onclick = ()=>desc.classList.toggle('collapsed');

  comentariosIframe.src = `comentarios.html?filme_id=${item.id}&tipo=${item.tipo}`;

  tocar(item.video_url);
}

// üöÄ BUSCA
(async ()=>{
  const { data:item, error } = await sb
    .from('conteudos')
    .select('*')
    .eq('id', id)
    .single();

  if(error || !item){
    alert('Conte√∫do n√£o encontrado');
    console.error(error);
    return;
  }
  render(item);
})();
</script>

</body>
</html>
