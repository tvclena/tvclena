<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clena TV â€¢ Ao Vivo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="env.js"></script>

<meta name="theme-color" content="#000">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:Inter,Arial}

video{
  width:100vw;
  height:100vh;
  object-fit:cover;
  background:#000;
}

#liveBadge{
  position:fixed;
  top:14px;
  left:14px;
  background:#e50914;
  padding:6px 12px;
  border-radius:999px;
  font-size:13px;
  font-weight:700;
  z-index:10;
  display:flex;
  align-items:center;
  gap:6px;
}
#dot{
  width:8px;
  height:8px;
  background:#fff;
  border-radius:50%;
  animation:pulse 1.2s infinite;
}
@keyframes pulse{
  0%{opacity:1}
  50%{opacity:.4}
  100%{opacity:1}
}
</style>
</head>

<body>

<div id="liveBadge">
  <div id="dot"></div> AO VIVO
</div>

<video
  id="video"
  autoplay
  playsinline
  preload="auto"
></video>

<script>
const sb = supabase.createClient(
  window.ENV.SUPABASE_URL,
  window.ENV.SUPABASE_ANON_KEY
);

const video = document.getElementById("video");
const canalSlug = new URLSearchParams(location.search).get("canal") || "clena-series";

let inicioPrograma = null;
let programaIdAtual = null;

/* ðŸ”’ BLOQUEIOS */
video.controls = false;
video.disablePictureInPicture = true;
video.controlsList = "nodownload noplaybackrate nofullscreen";

/* ================= CANAL ================= */
async function getCanalId(){
  const { data } = await sb
    .from("canais")
    .select("id")
    .eq("slug", canalSlug)
    .single();
  return data?.id;
}

/* ================= PROGRAMA ================= */
async function carregarProgramaAtual(){
  const canalId = await getCanalId();
  if(!canalId) return;

  const agora = new Date().toISOString();

  const { data: prog } = await sb
    .from("programacao_ao_vivo")
    .select("*, filmes(*)")
    .eq("canal_id", canalId)
    .lte("inicio", agora)
    .gte("fim", agora)
    .single();

  if(!prog) return;

  // ðŸ‘‡ NÃƒO recarrega se for o mesmo programa
  if(programaIdAtual === prog.id) return;

  programaIdAtual = prog.id;
  iniciarPlayer(prog);
}

/* ================= PLAYER ================= */
function iniciarPlayer(prog){
  inicioPrograma = new Date(prog.inicio).getTime();

  video.pause();
  video.removeAttribute("src");
  video.load();

  video.src = prog.filmes.video_url;

  video.onloadedmetadata = () => {
    const offset = Math.floor((Date.now() - inicioPrograma) / 1000);
    video.currentTime = offset > 0 ? offset : 0;
    video.play().catch(()=>{});
  };
}

/* ================= DRIFT FIX ================= */
setInterval(() => {
  if (!inicioPrograma || !video.duration) return;

  const esperado = (Date.now() - inicioPrograma) / 1000;
  const diff = video.currentTime - esperado;

  if (Math.abs(diff) > 3) {
    video.currentTime = esperado;
  }
}, 5000);

/* ================= AUTO TROCA ================= */
video.addEventListener("ended", carregarProgramaAtual);

/* START */
carregarProgramaAtual();
setInterval(carregarProgramaAtual, 30000);
</script>

</body>
</html>
