<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clena TV ‚Ä¢ Ao Vivo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="env.js"></script>

<meta name="theme-color" content="#000">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#000;
  color:#fff;
  font-family:Inter,Arial,sans-serif;
  overflow:hidden;
}

/* HEADER */
header{
  position:fixed;
  top:0;
  left:0;
  right:0;
  height:54px;
  display:flex;
  align-items:center;
  gap:14px;
  padding:0 20px;
  background:linear-gradient(to bottom,rgba(0,0,0,.7),transparent);
  z-index:10;
}
header h1{
  font-size:18px;
  font-weight:800;
  letter-spacing:.5px;
}
#liveBadge{
  background:#e50914;
  padding:4px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:6px;
}
#liveBadge::before{
  content:"";
  width:8px;
  height:8px;
  background:#fff;
  border-radius:50%;
  animation:pulse 1.2s infinite;
}
@keyframes pulse{
  0%{opacity:1}
  50%{opacity:.4}
  100%{opacity:1}
}

/* VIDEO */
video{
  width:100vw;
  height:100vh;
  object-fit:cover;
  background:#000;
}

/* FALLBACK */
#fallback{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}
#fallback button{
  padding:16px 28px;
  font-size:16px;
  font-weight:800;
  border:none;
  border-radius:10px;
  background:#e50914;
  color:#fff;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <h1>CLENA TV</h1>
  <div id="liveBadge">AO VIVO</div>
</header>

<div id="fallback">
  <button onclick="iniciarManual()">‚ñ∂ Iniciar transmiss√£o</button>
</div>

<video
  id="video"
  autoplay
  muted
  playsinline
  preload="auto"
></video>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  window.ENV.SUPABASE_URL,
  window.ENV.SUPABASE_ANON_KEY
);

const video = document.getElementById("video");
const fallback = document.getElementById("fallback");

/* ================= HELPERS ================= */
function isBunnyId(val){
  return /^[a-f0-9-]{20,}$/i.test(val);
}
function bunnyToHls(id){
  return `https://vz-827c2cae-692.b-cdn.net/${id}/playlist.m3u8`;
}

/* ================= AO VIVO ================= */
async function carregarAoVivo(){
  console.log("üî¥ Buscando programa√ß√£o ao vivo...");

  const { data, error } = await sb
    .from("programacao")
    .select("inicio, filmes(*)")
    .order("inicio", { ascending: true })
    .limit(1);

  if(error || !data || !data.length){
    console.error("‚ùå Programa√ß√£o n√£o encontrada", error);
    return;
  }

  const filme = data[0].filmes;
  console.log("üì∫ Ao vivo:", filme.titulo);

  iniciarVideo(filme);
}

/* ================= PLAYER ================= */
async function iniciarVideo(filme){
  let src = filme.video_url;

  if(isBunnyId(src)){
    console.log("üé• Bunny ID detectado ‚Üí HLS");
    src = bunnyToHls(src);
  }

  console.log("‚ñ∂ SRC:", src);

  video.src = src;
  video.load();

  try{
    await video.play();
    setTimeout(()=>{
      video.muted = false;
      video.volume = 1;
    },300);
  }catch(e){
    console.warn("üö´ Autoplay bloqueado");
    fallback.style.display = "flex";
  }
}

/* ================= FALLBACK ================= */
async function iniciarManual(){
  fallback.style.display = "none";
  video.muted = false;
  await video.play();
}

/* ================= LOOP ================= */
video.addEventListener("ended", ()=>{
  video.currentTime = 0;
  video.play();
});

/* ================= START ================= */
carregarAoVivo();
</script>

</body>
</html>
