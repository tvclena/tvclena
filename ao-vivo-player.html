<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clena TV â€¢ Ao Vivo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="env.js"></script>

<meta name="theme-color" content="#000">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#000;
  color:#fff;
  font-family:Inter,Arial,sans-serif;
}

/* VIDEO FULLSCREEN */
video{
  width:100vw;
  height:100vh;
  object-fit:cover;
  background:#000;
}

/* AO VIVO BADGE */
#liveBadge{
  position:fixed;
  top:14px;
  left:14px;
  background:#e50914;
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
  font-weight:700;
  z-index:10;
  display:flex;
  align-items:center;
  gap:8px;
}
#liveBadge::before{
  content:"";
  width:8px;
  height:8px;
  background:#fff;
  border-radius:50%;
  animation:pulse 1.2s infinite;
}
@keyframes pulse{
  0%{opacity:1}
  50%{opacity:.4}
  100%{opacity:1}
}
</style>
</head>

<body>

<!-- ðŸ”´ AO VIVO -->
<div id="liveBadge">AO VIVO</div>

<!-- PLAYER -->
<video
  id="video"
  autoplay
  muted
  playsinline
  preload="auto"
></video>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  window.ENV.SUPABASE_URL,
  window.ENV.SUPABASE_ANON_KEY
);

const video = document.getElementById("video");
const canalSlug =
  new URLSearchParams(location.search).get("canal") || "clena-series";

/* ðŸ”’ BLOQUEIOS (TV REAL) */
video.controls = false;
video.disablePictureInPicture = true;
video.controlsList = "nodownload noplaybackrate nofullscreen";

/* ESTADO */
let playlist = [];
let indiceAtual = 0;

/* ================= PLAYLIST ================= */
async function carregarPlaylist(){
  const { data: canal, error: canalErr } = await sb
    .from("canais")
    .select("id")
    .eq("slug", canalSlug)
    .single();

  if(canalErr || !canal){
    console.error("Canal nÃ£o encontrado");
    return;
  }

  const { data, error } = await sb
    .from("canal_playlist")
    .select("ordem, filmes(*)")
    .eq("canal_id", canal.id)
    .eq("ativo", true)
    .order("ordem");

  if(error){
    console.error("Erro ao carregar playlist", error);
    return;
  }

  playlist = data || [];
}

/* ================= PLAYER ================= */
function tocarAtual(){
  if(!playlist.length) return;

  const item = playlist[indiceAtual].filmes;

  video.pause();
  video.src = item.video_url;
  video.load();

  video.onloadedmetadata = async () => {
    try {
      video.muted = true;        // ðŸ”’ garante autoplay
      await video.play();        // â–¶ï¸ inicia SEM bloqueio

      // ðŸ”Š libera Ã¡udio logo apÃ³s iniciar
      setTimeout(() => {
        video.muted = false;
        video.volume = 1;
      }, 300);

    } catch(e){
      console.warn("Autoplay bloqueado", e);
    }
  };
}

/* ================= PRÃ“XIMO ================= */
video.addEventListener("ended", () => {
  indiceAtual++;
  if(indiceAtual >= playlist.length){
    indiceAtual = 0; // ðŸ” loop do canal
  }
  tocarAtual();
});

/* ================= START ================= */
(async ()=>{
  await carregarPlaylist();
  tocarAtual();
})();
</script>

</body>
</html>
